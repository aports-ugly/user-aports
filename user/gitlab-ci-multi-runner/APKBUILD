# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=gitlab-ci-multi-runner
pkgver=1.11.1
pkgrel=0
pkgdesc="Official GitLab Runner written in Go"
url="https://gitlab.com/gitlab-org/gitlab-ci-multi-runner"
arch="all"
license="MIT"
pkgusers="gitlab-runner"
pkggroups="$pkgusers"
makedepends="docker go go-bindata"
install="$pkgname.pre-install"
source="$pkgname-$pkgver.tar.gz::https://gitlab.com/gitlab-org/$pkgname/repository/archive.tar.gz?ref=v$pkgver
	$pkgname-$pkgver-prebuilt-x86_64.tar.xz.bin::https://$pkgname-downloads.s3.amazonaws.com/v$pkgver/docker/prebuilt-x86_64.tar.xz
	$pkgname-$pkgver-prebuilt-arm.tar.xz.bin::https://$pkgname-downloads.s3.amazonaws.com/v$pkgver/docker/prebuilt-arm.tar.xz
	$pkgname.initd
	$pkgname.logrotate
	Makefile-verbose.patch
	log-timestamp.patch
	log-without-colors.patch"
builddir="$srcdir/src/gitlab.com/gitlab-org/$pkgname"

_shortname="gitlab-runner"

prepare() {
	cd "$srcdir"

	local dirname=$(basename $pkgname-v$pkgver-*)
	_gitrev=${dirname##*-}

	mkdir -p "${builddir%/*}"
	mv $pkgname-v$pkgver-* "$builddir" || return 1

	default_prepare || return 1

	mkdir -p "$builddir"/out/docker
	local arch; for arch in x86_64 arm; do
		cp -L "$srcdir"/*-prebuilt-$arch.* \
			"$builddir"/out/docker/prebuilt-$arch.tar.xz || return 1
	done
}

build() {
	cd "$builddir"

	local branch=${pkgver%.*}
	branch="${branch/./-}-stable"

	GOPATH="$srcdir" make \
		RELEASE="true" \
		VERSION="$pkgver" \
		REVISION="$_gitrev" \
		BRANCH="$branch" \
		build_current
}

package() {
	cd "$builddir"

	install -D -m 755 out/binaries/$pkgname \
		"$pkgdir"/usr/bin/$pkgname || return 1

	install -D -m 755 "$srcdir"/$pkgname.initd \
		"$pkgdir"/etc/init.d/$pkgname || return 1

	install -D -m 644 "$srcdir"/$pkgname.logrotate \
		"$pkgdir"/etc/logrotate.d/$pkgname || return 1

	local dir; for dir in etc var/lib; do
		install -d -m 750 -o $pkgusers -g $pkggroups \
			"$pkgdir"/$dir/$_shortname || return 1
	done

	install -m 640 -o $pkgusers -g $pkggroups config.toml.example \
		"$pkgdir"/etc/$_shortname/config.toml || return 1

	ln -s /etc/$_shortname "$pkgdir"/var/lib/$_shortname/.gitlab-runner
}

md5sums="f76e10e059f04117fd40891b0dc46fb3  gitlab-ci-multi-runner-1.11.1.tar.gz
c07cd1cede1f8154e85bd35d6815f38a  gitlab-ci-multi-runner-1.11.1-prebuilt-x86_64.tar.xz.bin
9504f4ea023cea0a1a5b4c3781158c6c  gitlab-ci-multi-runner-1.11.1-prebuilt-arm.tar.xz.bin
56f4440a0bb05d097f7365175a8cbdfd  gitlab-ci-multi-runner.initd
4242a5cd4650e84fdb07691866f0bfe2  gitlab-ci-multi-runner.logrotate
9a6d1f1b1fb4821d5974c283e04b118f  Makefile-verbose.patch
7076beb9ee5dcd2c840534860bc0dd9d  log-timestamp.patch
24e68a44d7e8ca66be8010cbf27d6eff  log-without-colors.patch"
sha256sums="0aa1886aa57b61a8b2c29849e0c8bc322c6989303c32d00ab3087647d89e914d  gitlab-ci-multi-runner-1.11.1.tar.gz
1581e1534e80e8fa72ede15171269728f8123a18a0654975a7cf44daf8e650b9  gitlab-ci-multi-runner-1.11.1-prebuilt-x86_64.tar.xz.bin
fc0bfbd4f5289b738ce73a27e6ab65687187c01b2709d6c50dd92c868f500d5b  gitlab-ci-multi-runner-1.11.1-prebuilt-arm.tar.xz.bin
3264259286093436e7b75104ad989c9ec541a99d2d4c4fd5b15c2af1b258db66  gitlab-ci-multi-runner.initd
9e4a248fefb9702eabf287e4aabb2ab1680df708a2e7330c01f0d82423265345  gitlab-ci-multi-runner.logrotate
8ef5c97ef223783b172bae9f4ea30ed8aa11ca0d5eacb0fc12834d843a214026  Makefile-verbose.patch
74c75dd168d2f4746e6a3c9bf52736f983f1df02ee66a5fa74bde5b5b5a2b76f  log-timestamp.patch
6a430c122e667e8e869110e736f5bfb83be89ca08f215e489895a30b9236c7a5  log-without-colors.patch"
sha512sums="645ac9011145d2a48ca91bba22dc37f195b0dc9d6f41f7b97e2d1850f605ca637cf5d1305536bf805c2fa1825180afc5a0fe5dce0fcfc66b9c82403e93971fd2  gitlab-ci-multi-runner-1.11.1.tar.gz
096cfd4966c42c7102d7970e30aa22f4b6059b846013d10ccc8bc9aa118cf66033eda3f668af72414bdfea951e5e995bda48cd36356a3669ed792c0c28ee229b  gitlab-ci-multi-runner-1.11.1-prebuilt-x86_64.tar.xz.bin
d582da82223a7161a91da5934004e7fea25a7856a5bf5590e19cc86b6f39017c2c2a7ab80f9bbdb9ef9fa8726861c18312d97fe5e6f8d0a183fac7e23dfb7e31  gitlab-ci-multi-runner-1.11.1-prebuilt-arm.tar.xz.bin
9b9e09af635aebd4b682a12b671b22c786862394e85a57519e0f1c3d9ae97a173ee0a8526e81394c2a2d9f51527f8b264e5ebeff2d479513213c8114305c2441  gitlab-ci-multi-runner.initd
194440d43e1796f35ae61cae8f76874435e03dc3977af47bde0056ec37a631f4e13b0014f91d9dbf06b37d606bf47629d6e55d013eb7a289df1d5cd0f7848dff  gitlab-ci-multi-runner.logrotate
95d4add06c080ac6e3a68b9ff9e2d16b01cc59d5b0b184f617c03d62e2ba686a7a246c2a53934413dadbbb7d3086de64a1dd08518f33443ee24c50bc94501453  Makefile-verbose.patch
a0c808f39a5dca4fa6885b80ecb10e4a09302330bd4aedb9c799fc8a4888c42e5045961b60659ff98bd4264b9ddc2ad9f242b1175755d4bc3c438c6c19b980ff  log-timestamp.patch
2dcbcc7d0999ad84eb407c5f74b6dfb60ec91fad1a0feb4e4ee2758e177bd0004d9766ebb8b59b8dbb8413f28f339b7696ebcedbdb17c30ebb2e96fc6d0a71a9  log-without-colors.patch"
