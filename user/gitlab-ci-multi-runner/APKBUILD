# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=gitlab-ci-multi-runner
pkgver=1.10.4
pkgrel=0
pkgdesc="Official GitLab Runner written in Go"
url="https://gitlab.com/gitlab-org/gitlab-ci-multi-runner"
arch="all"
license="MIT"
pkgusers="gitlab-runner"
pkggroups="$pkgusers"
makedepends="docker go go-bindata"
install="$pkgname.pre-install"
source="$pkgname-$pkgver.tar.gz::https://gitlab.com/gitlab-org/$pkgname/repository/archive.tar.gz?ref=v$pkgver
	$pkgname-$pkgver-prebuilt-x86_64.tar.xz.bin::https://$pkgname-downloads.s3.amazonaws.com/v$pkgver/docker/prebuilt-x86_64.tar.xz
	$pkgname-$pkgver-prebuilt-arm.tar.xz.bin::https://$pkgname-downloads.s3.amazonaws.com/v$pkgver/docker/prebuilt-arm.tar.xz
	$pkgname.initd
	$pkgname.logrotate
	Makefile-verbose.patch"
builddir="$srcdir/src/gitlab.com/gitlab-org/$pkgname"

_shortname="gitlab-runner"

prepare() {
	cd "$srcdir"

	local dirname=$(basename $pkgname-v$pkgver-*)
	_gitrev=${dirname##*-}

	mkdir -p "${builddir%/*}"
	mv $pkgname-v$pkgver-* "$builddir" || return 1

	mkdir -p "$builddir"/out/docker
	local arch; for arch in x86_64 arm; do
		mv *-prebuilt-$arch.* "$builddir"/out/docker/prebuilt-$arch.tar.xz || return 1
	done

	default_prepare
}

build() {
	cd "$builddir"

	local branch=${pkgver%.*}
	branch="${branch/./-}-stable"

	GOPATH="$srcdir" make \
		RELEASE="true" \
		VERSION="$pkgver" \
		REVISION="$_gitrev" \
		BRANCH="$branch" \
		build_current
}

package() {
	cd "$builddir"

	install -D -m 755 out/binaries/$pkgname \
		"$pkgdir"/usr/bin/$pkgname || return 1

	install -D -m 755 "$srcdir"/$pkgname.initd \
		"$pkgdir"/etc/init.d/$pkgname || return 1

	install -D -m 644 "$srcdir"/$pkgname.logrotate \
		"$pkgdir"/etc/logrotate.d/$pkgname || return 1

	local dir; for dir in etc var/lib var/log; do
		install -d -m 750 -o $pkgusers -g $pkggroups \
			"$pkgdir"/$dir/$_shortname || return 1
	done

	install -m 640 -o $pkgusers -g $pkggroups config.toml.example \
		"$pkgdir"/etc/$_shortname/config.toml || return 1

	ln -s /etc/$_shortname "$pkgdir"/var/lib/$_shortname/.gitlab-runner
}

sha512sums="d47fd24e87afd4c261e526dccc97aaa6d6ac1a5744df85ad44752f49c8f72af59cedc0c6c24a19fcb9bbf8b8703261ecf9568fe69d3ca3012142f46ce8e82d86  gitlab-ci-multi-runner-1.10.4.tar.gz
277576ef1a3bbe55f9fa67ea0c957ab1cd3d19ed402efb1124cc0784ab070606e5db973bbaeeee9208ee1f7d9334ff9e3edccc7efcd9a25ac4ae28fe3434b2d1  gitlab-ci-multi-runner-1.10.4-prebuilt-x86_64.tar.xz.bin
8ff0967105a0cd7d5041823b677a1bb990620c7cfe40975768691b738e37f72394323616c1783add5622696e645916caed18722d6b242974f49ee3da658bee8a  gitlab-ci-multi-runner-1.10.4-prebuilt-arm.tar.xz.bin
a18f6b052c3c7c3829e2b75c6cbfae1aef7348021ff04eeba4130edb4bc8899774b3bf7026d215001202fb17419bbfe8daab0bf0c57e0022c2b053bee7664b28  gitlab-ci-multi-runner.initd
958e522ed517f524a0804f9ad2ed08fcf340ecc958f160a1ea11fb069cb29ff86ce9705072fafb364254a7fa2dca7d8dcc66ac30c1a4eac6fa76363703e45cbf  gitlab-ci-multi-runner.logrotate
95d4add06c080ac6e3a68b9ff9e2d16b01cc59d5b0b184f617c03d62e2ba686a7a246c2a53934413dadbbb7d3086de64a1dd08518f33443ee24c50bc94501453  Makefile-verbose.patch"
