# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=gitlab-workhorse
pkgver=0.8.2
pkgrel=0
pkgdesc="A reverse proxy for GitLab."
pkgusers="git"
url="https://gitlab.com/gitlab-org/gitlab-workhorse/"
arch="all"
license="MIT"
depends=""
makedepends="go>=1.5"
source="$pkgname-$pkgver.tar.gz::https://gitlab.com/gitlab-org/$pkgname/repository/archive.tar.gz?ref=v$pkgver
	$pkgname.initd
	"
builddir="$srcdir/$pkgname-$pkgver"

prepare() {
	cd "$srcdir"

	# Top-level directory inside the tar archive contains SHA of a commit...
	mv $pkgname-v$pkgver-* "$builddir"
}

build() {
	cd "$builddir"

	make VERSION=$pkgver
}

package() {
	cd "$builddir"

	make install PREFIX="$pkgdir/usr" || return 1

	install -m755 -D "$srcdir"/$pkgname.initd \
		"$pkgdir"/etc/init.d/gitlab.workhorse
}

md5sums="4f5a2b358a6e6c51216323459fd8854d  gitlab-workhorse-0.8.2.tar.gz
5df319a20a80deba11a0d8c1460cb38e  gitlab-workhorse.initd"
sha256sums="050734604b993957e7b1060035a5709c3dfc03a6a9ed7aafa3f26f32691f6448  gitlab-workhorse-0.8.2.tar.gz
4e36c923dd39a7a30a42b6f0669bbb33ae164c46c2a6e1554b907b5297a480c2  gitlab-workhorse.initd"
sha512sums="cfc0c54ba1d7ad9df5c98961ba7124fde3ed1857d81667736f439024ca7b878f31028f998c8222b4a4686868934816921b33d6245523a85f3276312c0862a5ad  gitlab-workhorse-0.8.2.tar.gz
6b369aaad4cc40c19a6561910a6ba3f51f907fb03d7136d2d0fcd8f908561d7eab7b0da0692a6c57195231123371e30a188e4076b0758a8e2d04e75cfb95615a  gitlab-workhorse.initd"
