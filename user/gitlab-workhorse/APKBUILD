# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=gitlab-workhorse
pkgver=1.4.3
pkgrel=0
pkgdesc="A reverse proxy for GitLab."
pkgusers="git"
url="https://gitlab.com/gitlab-org/gitlab-workhorse/"
arch="all"
license="MIT"
makedepends="go>=1.5"
source="$pkgname-$pkgver.tar.gz::https://gitlab.com/gitlab-org/$pkgname/repository/archive.tar.gz?ref=v$pkgver
	workhorse.toml
	$pkgname.initd"
builddir="$srcdir/$pkgname-$pkgver"

prepare() {
	# Top-level directory inside the tar archive contains SHA of a commit...
	mv "$srcdir"/$pkgname-v$pkgver-* "$builddir"

	default_prepare
}

build() {
	cd "$builddir"

	make VERSION=$pkgver
}

package() {
	cd "$builddir"

	make install PREFIX="$pkgdir/usr"

	install -m644 -D "$srcdir"/workhorse.toml "$pkgdir"/etc/gitlab/workhorse.toml
	install -m755 -D "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/gitlab.workhorse
}

sha512sums="fb1835ef8e56040b191ae01c8c3024704aba9217f79169c1b46b70b3c4d39327800ad6ca01cc08fb006aa778c7a14e8eacf7805cde7d72eaff04d995bca2dbb4  gitlab-workhorse-1.4.3.tar.gz
303847382fc973c92dd951ee43f7e06ecd3c7c6655752877cd2171e4c267a2dbbeed1faa45814d4bcc2a41a2a9f57d7a62366f0082612d50a5b935d9493ace52  workhorse.toml
cbbb805e31711713a7a279f08f1a22a3c1e56ce0e4ea27ccdb7bb0290b4747f86dd3f62a94cae8cf608d7700df2088bf0777eb3898866b939d47775839d76b59  gitlab-workhorse.initd"
