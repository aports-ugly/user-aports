# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=gitlab-shell
pkgver=5.0.4
pkgrel=0
pkgdesc="GitLab Shell handles git commands for GitLab."
url="https://github.com/gitlabhq/gitlab-shell"
arch="noarch"
license="MIT"
_rubyslot=""
depends="git>=2.8.4 openssh redis>=2.8 ruby$_rubyslot ruby$_rubyslot-json"
pkgusers="git"
pkggroups="git"
install="$pkgname.pre-install $pkgname.post-install"
source="$pkgname-$pkgver.tar.gz::https://gitlab.com/gitlab-org/$pkgname/repository/archive.tar.gz?ref=v$pkgver
	gitconfig
	0001-fix-paths.patch"
builddir="$srcdir/$pkgname-$pkgver"

prepare() {
	mkdir -p "$builddir"
	mv "$srcdir"/$pkgname-v$pkgver-*/* "$builddir"/

	default_prepare  # apply patches

	#cd "$builddir"
	# Change shebang in ruby scripts.
	#local file; for file in bin/* hooks/*; do
	#	sed -i "s|/usr/bin/env ruby|/usr/bin/env ruby$_rubyslot|" $file
	#done
}

package() {
	local datadir="$pkgdir"/var/lib/gitlab

	cd "$builddir"

	install -d -m755 \
		"$pkgdir"/usr/bin \
		"$pkgdir"/usr/share/$pkgname

	install -d -m755 -o git -g git \
		"$pkgdir"/var/log/gitlab \
		"$datadir"

	install -d -m02770 -o git -g git \
		"$datadir"/repositories

	cp -r VERSION bin hooks lib "$pkgdir"/usr/share/$pkgname/

	install -m644 -o git -g git "$srcdir"/gitconfig "$datadir"/.gitconfig
	install -m644 -D config.yml.example "$pkgdir"/etc/gitlab/gitlab-shell.yml
}

sha512sums="2718e99a43ad934dfb6d8b3df47bab0b957fa362c84510434fdd07ed994bf53ab059569ff0da106c8bd5ebc49cc460694ad5fb2fec57f0fb0cbb297609a00d97  gitlab-shell-5.0.4.tar.gz
d2f0740bccc5ff19d36a83c61ebb8e5f110662d3f5ddd3520cd5f59d4c65bbaf3f980512f49a841f153a446a3501f79606a263c892ecf1954fd3549143dcf7f9  gitconfig
defe783daeac051ad31e81d4b6912bdcf5810deb06b89f771eaf056c3caac005b6f628f4aaac47e1b8ac46bb0e4c1f32346d87d4577c1089bf1334954393cf0f  0001-fix-paths.patch"
