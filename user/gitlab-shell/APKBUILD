# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=gitlab-shell
pkgver=5.0.5
pkgrel=0
pkgdesc="GitLab Shell handles git commands for GitLab."
url="https://github.com/gitlabhq/gitlab-shell"
arch="noarch"
license="MIT"
_rubyslot=""
depends="git>=2.8.4 openssh redis>=2.8 ruby$_rubyslot ruby$_rubyslot-json"
pkgusers="git"
pkggroups="git"
install="$pkgname.pre-install $pkgname.post-install"
source="$pkgname-$pkgver.tar.gz::https://gitlab.com/gitlab-org/$pkgname/repository/archive.tar.gz?ref=v$pkgver
	gitconfig
	0001-fix-paths.patch"
builddir="$srcdir/$pkgname-$pkgver"

prepare() {
	mkdir -p "$builddir"
	mv "$srcdir"/$pkgname-v$pkgver-*/* "$builddir"/ || return 1

	default_prepare || return 1  # apply patches

	#cd "$builddir"
	# Change shebang in ruby scripts.
	#local file; for file in bin/* hooks/*; do
	#	sed -i "s|/usr/bin/env ruby|/usr/bin/env ruby$_rubyslot|" $file || return 1
	#done
}

package() {
	local datadir="$pkgdir"/var/lib/gitlab

	cd "$builddir"

	install -d -m755 \
		"$pkgdir"/usr/bin \
		"$pkgdir"/usr/share/$pkgname || return 1

	install -d -m755 -o git -g git \
		"$pkgdir"/var/log/gitlab \
		"$datadir" || return 1

	install -d -m02770 -o git -g git \
		"$datadir"/repositories || return 1

	cp -r VERSION bin hooks lib "$pkgdir"/usr/share/$pkgname/ || return 1

	install -m644 -o git -g git "$srcdir"/gitconfig "$datadir"/.gitconfig || return 1
	install -m644 -D config.yml.example "$pkgdir"/etc/gitlab/gitlab-shell.yml
}

sha512sums="8e22a2bed622c81976b827fac81ca94de7023d710160cb6daa24d24269b068292ee2e36a5917bb5399340661a28f6480ac40c0a5253f71bd36b8bd78a56c7380  gitlab-shell-5.0.5.tar.gz
d2f0740bccc5ff19d36a83c61ebb8e5f110662d3f5ddd3520cd5f59d4c65bbaf3f980512f49a841f153a446a3501f79606a263c892ecf1954fd3549143dcf7f9  gitconfig
defe783daeac051ad31e81d4b6912bdcf5810deb06b89f771eaf056c3caac005b6f628f4aaac47e1b8ac46bb0e4c1f32346d87d4577c1089bf1334954393cf0f  0001-fix-paths.patch"
