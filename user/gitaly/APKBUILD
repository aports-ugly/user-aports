# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=gitaly
# Note: When updating check changes in config.toml.example!
pkgver=0.21.2
pkgrel=1
pkgdesc="A Git RPC service for handling all the git calls made by GitLab"
pkgusers="git"
url="https://gitlab.com/gitlab-org/gitaly/"
arch="all"
license="MIT"
depends="git"
makedepends="go>=1.8"
source="$pkgname-$pkgver.tar.gz::https://gitlab.com/gitlab-org/$pkgname/repository/archive.tar.gz?ref=v$pkgver
	$pkgname.initd
	config.toml"
builddir="$srcdir/$pkgname-$pkgver"
options="!check"

prepare() {
	# Top-level directory inside the tar archive contains SHA of a commit...
	mv "$srcdir"/$pkgname-v$pkgver-* "$builddir"

	default_prepare
}

build() {
	cd "$builddir"

	make VERSION=$pkgver
}

package() {
	cd "$builddir"

	install -m755 -D _build/bin/gitaly "$pkgdir"/usr/bin/gitaly

	install -m644 -D "$srcdir"/config.toml "$pkgdir"/etc/gitlab/gitaly.toml
	install -m755 -D "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/gitlab.gitaly
}

sha512sums="985971c0207fdc42ccfc8f51da23966fcf217585134ca788ae0e88db8961cd0febcc7b645a428045e36f64502f362141cd831666a07d16ee30751aa86006022a  gitaly-0.21.2.tar.gz
89fc0b1c1fa95071ae5ede0ba73bba99ef3a6cd726d39297c146248a633580d8d04c2ddbff182d33cb7d2b09dfa7fca6fe5167bc8a38e173c0b2505f4467453b  gitaly.initd
66f7cfb84193d8ee65672f0f48c188d9b58946f35c0a77c1676a871154e59b6a05abd970cc5375df9e39b1cf3a37b1a3c17c3e6fd45afbdbe1d24502a375fbf0  config.toml"
