# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=gitlab-pages
pkgver=0.4.3
pkgrel=0
pkgdesc="A daemon used to serve static websites for GitLab users"
url="https://gitlab.com/gitlab-org/gitlab-pages/"
arch="all"
license="MIT"
makedepends="go>=1.5"
source="$pkgname-$pkgver.tar.gz::https://gitlab.com/gitlab-org/$pkgname/repository/archive.tar.gz?ref=v$pkgver
	ungit-makefile.patch
	$pkgname.initd"
builddir="$srcdir/src/gitlab.com/gitlab-org/$pkgname"

prepare() {
	local dirname=$(basename $pkgname-v$pkgver-*)
	_gitrev=${dirname##*-}

	mkdir -p "$builddir"
	mv "$srcdir"/$dirname/* "$builddir"/ || return 1

	default_prepare
}

build() {
	cd "$builddir"
	make VERSION=$pkgver REVISION=$_gitrev GOPATH="$srcdir" CGO_ENABLED=0
}

package() {
	cd "$builddir"

	install -D -m 755 $pkgname "$pkgdir"/usr/bin/$pkgname
	install -m755 -D "$srcdir"/$pkgname.initd \
		"$pkgdir"/etc/init.d/gitlab.pages
}

sha512sums="d3c2e3dcf78d050e2f2b28b923ba9aa9adc4d9a4482d339a82760d922bb488f8b10e943f7699fbaf32537e33226d4aa4aa55688007c10a1991089587645ab2c4  gitlab-pages-0.4.3.tar.gz
6c80a1eae1bca1f86629a1f3880c1a9fca9d0a6fab90ec07474addd544fc3f2d3d63c507741a550112b54d98da2e55d06100236a87d2b52892acdcfd12b3ddfe  ungit-makefile.patch
20bc66c1c3548568ed353ca8d584f9108b9688f9375f212a18efc7b8386fdaafb3b2dc9e865f21c7f8fd31ada6e91842a8bb8d397f64851d853bb0de3e0e60bb  gitlab-pages.initd"
