From 68f8f41fef8d1283b5ee2c5c60e8ee451c8db94f Mon Sep 17 00:00:00 2001
From: Jakub Jirutka <jakub@jirutka.cz>
Date: Wed, 16 Aug 2017 21:26:53 +0200
Subject: [PATCH] Don't load prometheus when not installed/enabled

---
 app/services/metrics_service.rb             |  6 ++++--
 config/initializers/7_prometheus_metrics.rb | 19 ++++++++++++-------
 lib/gitlab/metrics/prometheus.rb            |  6 +++---
 3 files changed, 19 insertions(+), 12 deletions(-)

diff --git a/app/services/metrics_service.rb b/app/services/metrics_service.rb
index f3ed804..65a15ce 100644
--- a/app/services/metrics_service.rb
+++ b/app/services/metrics_service.rb
@@ -1,6 +1,6 @@
-require 'prometheus/client/formats/text'
-
 class MetricsService
+  include Gitlab::CurrentSettings
+
   CHECKS = [
     Gitlab::HealthChecks::DbCheck,
     Gitlab::HealthChecks::RedisCheck,
@@ -8,6 +8,8 @@ class MetricsService
   ].freeze
 
   def prometheus_metrics_text
+    return unless current_application_settings[:prometheus_metrics_enabled]
+
     Prometheus::Client::Formats::Text.marshal_multiprocess(multiprocess_metrics_path)
   end
 
diff --git a/config/initializers/7_prometheus_metrics.rb b/config/initializers/7_prometheus_metrics.rb
index a2f8421..d5d5a77 100644
--- a/config/initializers/7_prometheus_metrics.rb
+++ b/config/initializers/7_prometheus_metrics.rb
@@ -1,12 +1,17 @@
-require 'prometheus/client'
+begin
+  require 'prometheus/client'
+  require 'prometheus/client/formats/text'
 
-Prometheus::Client.configure do |config|
-  config.logger = Rails.logger
+  Prometheus::Client.configure do |config|
+    config.logger = Rails.logger
 
-  config.initial_mmap_file_size = 4 * 1024
-  config.multiprocess_files_dir = ENV['prometheus_multiproc_dir']
+    config.initial_mmap_file_size = 4 * 1024
+    config.multiprocess_files_dir = ENV['prometheus_multiproc_dir']
 
-  if Rails.env.development? || Rails.env.test?
-    config.multiprocess_files_dir ||= Rails.root.join('tmp/prometheus_multiproc_dir')
+    if Rails.env.development? || Rails.env.test?
+      config.multiprocess_files_dir ||= Rails.root.join('tmp/prometheus_multiproc_dir')
+    end
   end
+rescue LoadError
+  # skip if prometheus-client is not installed
 end
diff --git a/lib/gitlab/metrics/prometheus.rb b/lib/gitlab/metrics/prometheus.rb
index 460dab4..a92aef2 100644
--- a/lib/gitlab/metrics/prometheus.rb
+++ b/lib/gitlab/metrics/prometheus.rb
@@ -1,11 +1,11 @@
-require 'prometheus/client'
-
 module Gitlab
   module Metrics
     module Prometheus
       include Gitlab::CurrentSettings
 
       def metrics_folder_present?
+        return false unless prometheus_metrics_enabled?
+
         multiprocess_files_dir = ::Prometheus::Client.configuration.multiprocess_files_dir
 
         multiprocess_files_dir &&
@@ -50,7 +50,7 @@ module Gitlab
       private
 
       def prometheus_metrics_enabled_unmemoized
-        metrics_folder_present? && current_application_settings[:prometheus_metrics_enabled] || false
+        current_application_settings[:prometheus_metrics_enabled] && metrics_folder_present? || false
       end
     end
   end
-- 
2.10.1 (Apple Git-78)

