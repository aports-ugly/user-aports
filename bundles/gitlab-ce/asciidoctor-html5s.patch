From e4d546147b3bf7f0b5df83244447d8e6e3ef6c2d Mon Sep 17 00:00:00 2001
From: Jakub Jirutka <jakub@jirutka.cz>
Date: Tue, 12 Sep 2017 12:30:36 +0200
Subject: [PATCH] Significantly improve AsciiDoc rendering

---
 Gemfile                                            |   2 +
 Gemfile.lock                                       |   8 +
 app/assets/stylesheets/framework/asciidoctor.scss  | 180 +++++++++++++++++++--
 .../filter/ascii_doc_post_processing_filter.rb     |  12 ++
 lib/gitlab/asciidoc.rb                             |  11 +-
 5 files changed, 196 insertions(+), 17 deletions(-)

diff --git a/Gemfile b/Gemfile
index 84e26c2..fc31dbc 100644
--- a/Gemfile
+++ b/Gemfile
@@ -120,7 +120,9 @@ gem 'org-ruby', '~> 0.9.12'
 gem 'creole', '~> 0.5.0'
 gem 'wikicloth', '0.8.1'
 gem 'asciidoctor', '~> 1.5.2'
+gem 'asciidoctor-html5s', '= 0.1.0.beta.4'
 gem 'asciidoctor-plantuml', '0.0.7'
+gem 'asciidoctor-rouge', '~> 0.1.0', require: false
 gem 'rouge', '~> 2.0'
 gem 'truncato', '~> 0.7.9'
 gem 'bootstrap_form', '~> 2.7.0'
diff --git a/Gemfile.lock b/Gemfile.lock
index 283f360..26b883a 100644
--- a/Gemfile.lock
+++ b/Gemfile.lock
@@ -59,8 +59,14 @@ GEM
       faraday_middleware-multi_json (~> 0.0)
       oauth2 (~> 1.0)
     asciidoctor (1.5.6.1)
+    asciidoctor-html5s (0.1.0.beta.4)
+      asciidoctor (~> 1.5.5)
+      thread_safe (~> 0.3.4)
     asciidoctor-plantuml (0.0.7)
       asciidoctor (~> 1.5)
+    asciidoctor-rouge (0.1.0)
+      asciidoctor (~> 1.5.6)
+      rouge (~> 2.2)
     ast (2.3.0)
     atomic (1.1.99)
     attr_encrypted (3.0.3)
@@ -924,7 +930,9 @@ DEPENDENCIES
   allocations (~> 1.0)
   asana (~> 0.6.0)
   asciidoctor (~> 1.5.2)
+  asciidoctor-html5s (= 0.1.0.beta.4)
   asciidoctor-plantuml (= 0.0.7)
+  asciidoctor-rouge (~> 0.1.0)
   attr_encrypted (~> 3.0.0)
   awesome_print (~> 1.2.0)
   babosa (~> 1.0.2)
diff --git a/app/assets/stylesheets/framework/asciidoctor.scss b/app/assets/stylesheets/framework/asciidoctor.scss
index 62493c3..c9d3542 100644
--- a/app/assets/stylesheets/framework/asciidoctor.scss
+++ b/app/assets/stylesheets/framework/asciidoctor.scss
@@ -1,27 +1,179 @@
-.admonitionblock td.icon {
-  width: 1%;
+// Rules for asciidoctor-html5s converter.
 
-  [class^="fa icon-"] {
-    @extend .fa-2x;
+.wiki {
+  @mixin black-circle-bg {
+    display: inline-block;
+    background-color: $black;
+    border-radius: 50%;
+    color: $white-light;
+    text-align: center;
+    font-size: 0.85em;
+    line-height: 1.4em;
+    height: 1.4em;
+    width: 1.4em;
   }
 
-  .icon-note {
-    @extend .fa-thumb-tack;
+  .doc-section {
+    // This substitutes margin-top on h1-6 that is zeroed by :first-child rule.
+    margin-top: 24px;
   }
 
-  .icon-tip {
-    @extend .fa-lightbulb-o;
+  .block-title {
+    font-size: 1em;
+    margin: ($gl-padding / 2) 0;
   }
 
-  .icon-warning {
-    @extend .fa-exclamation-triangle;
+  .toc {
+    margin: $gl-padding 0;
   }
 
-  .icon-caution {
-    @extend .fa-fire;
+  .toc-list {
+    list-style-type: none;
+    margin: 0;
+
+    li:before {
+      content: "â€º\00a0";
+      margin-left: -$gl-padding;
+    }
+  }
+
+  figure {
+    margin: ($gl-padding * 1.5) 0;
+
+    // FIXME
+    & > img {
+      margin-bottom: 0 !important;
+    }
+  }
+
+  figcaption {
+    font-weight: 600;
+    margin: ($gl-padding / 2) 0;
+  }
+
+  // FIXME
+  figcaption + *,
+  .block-title + * {
+    margin-top: 0 !important;
+  }
+
+  // Override some extern rule that mess with footer.
+  blockquote > footer {
+    color: inherit;
+
+    &:before {
+      content: normal;
+    }
   }
 
-  .icon-important {
-    @extend .fa-exclamation-circle;
+  dt {
+    margin-bottom: $gl-padding / 2;
+  }
+
+  dd {
+    margin-left: 1em;
+  }
+
+  .menuseq b.caret {
+    @extend .fa-angle-right;
+  }
+
+  // Code callout (a mark inside the code).
+  .code b.conum {
+    @include black-circle-bg;
+    font-weight: normal;
+    font-family: $regular_font;
+  }
+
+  // Code callouts list, styled as numbers in black circles.
+  .callout-list {
+    counter-reset: callout-list;
+    list-style-type: none;
+    margin-top: -$gl-padding / 2;
+    margin-bottom: $gl-padding * 1.5;
+
+    & > li:before {
+      @include black-circle-bg;
+      content: counter(callout-list);
+      counter-increment: callout-list;
+      margin-left: -2em;
+      margin-right: 0.6em;
+    }
+  }
+
+  .example-block > .example {
+    background-color: $gray-normal;
+    border: 1px solid $border-color;
+    border-radius: $border-radius-default;
+    padding: $gl-padding;
+    padding-bottom: 0;
+    margin: $gl-padding 0;
+  }
+
+  .admonition-block {
+    border: 1px solid $border-color;
+    border-radius: $border-radius-default;
+    display: flex;
+    flex-direction: column;
+    margin-bottom: $gl-padding;
+    padding: $gl-padding $gl-padding 0 4.2em;
+    position: relative;
+    width: 100%;
+
+    &:before {
+      position: absolute;
+      top: 0;
+      bottom: 0;
+      left: 0;
+      margin: auto 0;
+      height: 1.8em;
+      width: 2.4em;
+
+      font-family: FontAwesome;
+      font-size: 1.8em;
+      line-height: 1.8em;
+      text-align: center;
+    }
+
+    &.note,
+    &.tip {
+      background-color: #ffffef;
+    }
+
+    &.warning,
+    &.caution,
+    &.important {
+      background-color: #ffefef;
+    }
+
+    &.note:before {
+      @extend .fa-thumb-tack;
+    }
+
+    &.tip:before {
+      @extend .fa-lightbulb-o;
+    }
+
+    &.warning:before {
+      @extend .fa-exclamation-triangle;
+    }
+
+    &.caution:before {
+      @extend .fa-bolt;
+    }
+
+    &.important:before {
+      @extend .fa-exclamation-circle;
+    }
+
+    .block-title {
+      margin-bottom: $gl-padding;
+    }
+
+    // e.g. "Warning: "
+    .block-title.label-only,
+    .title-label {
+      display: none;
+    }
   }
 }
diff --git a/lib/banzai/filter/ascii_doc_post_processing_filter.rb b/lib/banzai/filter/ascii_doc_post_processing_filter.rb
index c9fcf05..c401bd7 100644
--- a/lib/banzai/filter/ascii_doc_post_processing_filter.rb
+++ b/lib/banzai/filter/ascii_doc_post_processing_filter.rb
@@ -6,6 +6,18 @@ module Banzai
           node.set_attribute('class', 'code math js-render-math')
         end
 
+        doc.search('.rouge.highlight > code').each do |code|
+          lang = code.attr('data-lang')
+          pre = code.parent
+
+          code.remove_attribute('data-lang')
+          code.remove_attribute('class')
+
+          pre.set_attribute('class', "code highlight js-syntax-highlight #{lang}")
+          pre.set_attribute('lang', lang)
+          pre.set_attribute('v-pre', 'true')
+        end
+
         doc
       end
     end
diff --git a/lib/gitlab/asciidoc.rb b/lib/gitlab/asciidoc.rb
index b7ff4c6..6717c8d 100644
--- a/lib/gitlab/asciidoc.rb
+++ b/lib/gitlab/asciidoc.rb
@@ -1,7 +1,8 @@
 require 'asciidoctor'
-require 'asciidoctor/converter/html5'
 require 'asciidoctor/extensions'
+require 'asciidoctor-html5s'
 require "asciidoctor-plantuml"
+require 'asciidoctor/rouge/treeprocessor'
 
 module Gitlab
   # Parser/renderer for the AsciiDoc format that uses Asciidoctor and filters
@@ -9,10 +10,14 @@ module Gitlab
   module Asciidoc
     DEFAULT_ADOC_ATTRS = [
       'showtitle', 'idprefix=user-content-', 'idseparator=-', 'env=gitlab',
-      'env-gitlab', 'source-highlighter=html-pipeline', 'icons=font',
+      'env-gitlab', 'source-highlighter=rouge', 'icons=font',
       'sectanchors'
     ].freeze
 
+    Asciidoctor::Extensions.register do
+      treeprocessor Asciidoctor::Rouge::Treeprocessor.new(formatter_opts: { line_id: 'LC%i' })
+    end
+
     # Public: Converts the provided Asciidoc markup into HTML.
     #
     # input         - the source text in Asciidoc format
@@ -46,7 +51,7 @@ module Gitlab
       end
     end
 
-    class Html5Converter < Asciidoctor::Converter::Html5Converter
+    class Html5Converter < Asciidoctor::Html5s::Converter
       extend Asciidoctor::Converter::Config
 
       register_for 'gitlab_html5'
-- 
2.10.1 (Apple Git-78)

