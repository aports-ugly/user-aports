# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=gitlab-ce
_pkgname=${pkgname%-ce}
pkgver=9.4.7
pkgrel=7
pkgdesc="A version control for your server"
url="https://github.com/gitlabhq/gitlabhq"
arch="all"
license="MIT"
_rubyslot=""
_katex_ver=0.8.3
# ruby-irb is needed only for Rails console (gitlab-rails console)
depends="$pkgname-assets=$pkgver-r$pkgrel
	gitaly>=0.21.2
	gitlab-shell>=5.3.1
	gitlab-workhorse>=2.3.0
	ca-certificates
	git>=2.8.3
	http-parser
	libgit2>=0.24
	procps
	py-docutils
	python3
	redis>=2.8
	tzdata
	ruby$_rubyslot
	ruby$_rubyslot-io-console
	ruby$_rubyslot-bigdecimal
	ruby$_rubyslot-json
	ruby$_rubyslot-rake
	ruby$_rubyslot-irb
	ruby$_rubyslot-bundler>=1.5.2
	"
makedepends="
	icu-dev
	libgcrypt-dev
	libgit2-dev>=0.25
	libxml2-dev
	libxslt-dev
	linux-headers
	libressl-dev
	postgresql-dev
	protobuf-dev
	python2
	nodejs>=4.3.0
	re2-dev
	ruby$_rubyslot-dev
	ruby$_rubyslot-grpc
	yarn>=0.17.0
	"
pkgusers="git"
pkggroups="git"
install="$pkgname.pre-install $pkgname.post-install $pkgname.post-upgrade"
subpackages="$pkgname-assets::noarch"
source="$pkgname-$pkgver.tar.gz::https://github.com/gitlabhq/gitlabhq/archive/v$pkgver.tar.gz
	katex-$_katex_ver.tar.gz::https://github.com/Khan/KaTeX/releases/download/v$_katex_ver/katex.tar.gz
	$_pkgname.initd
	$_pkgname.mailroom.initd
	$_pkgname.sidekiq.initd
	$_pkgname.confd
	$_pkgname.logrotate
	bin-wrapper.in
	gemfile-exclude-unnecessary-gems.patch
	default-configs.patch
	dont-dump-schema.patch
	fix-setup-task.patch
	fix-check-task.patch
	replace-sys-filesystem.patch
	gitlab-revision.patch
	gemfile-use-local-grpc.patch
	gemfile-update-asciidoctor.patch
	gemfile-update-google-protobuf.patch
	asciidoc-enable-setanchors-by-default.patch
	asciidoc-include-directive.patch
	dont-load-prometheus-when-not-installed.patch
	asciidoctor-html5s.patch
	asciidoc-disable-html-sanitization.patch
	fix-help-page.patch
	fix-issue-board-on-ruby2.4.patch
	fix-project-feature-being-deleted-when-updating-proj.patch
	add-migration-to-fix-corrupted-projects.patch
	asciidoc-include-directive-2.patch
	asciidoc-outfilesuffix.patch
	render-index-like-readme.patch
	gemfile-update-asciidoctor-1.5.7.dev.patch
	katex-disable-throwOnError.patch
	asciidoctor-interdoc-reftext.patch
	extend-api-for-protected-branches.patch
	asciidoc-line-through.patch
	asciidoc-expose-metadata-as-attributes.patch
	"
builddir="$srcdir/gitlabhq-$pkgver"

_prefix="/usr/lib/bundles/$_pkgname"

prepare() {
	local sysgemdir=$(ruby$_rubyslot -rubygems -e 'puts Gem.default_dir')

	default_prepare

	cd "$builddir"

	# Change shebang to run with correct Ruby version.
	#local file; for file in bin/bundle bin/rails bin/rake; do
	#	sed -i "s|/usr/bin/env ruby|/usr/bin/env ruby$_rubyslot|" $file
	#done
	#sed -i "s|/usr/bin/env rake|/usr/bin/env rake$_rubyslot|" Rakefile

	# The default log level is very chatty.
	sed -i 's/^\(\s*config.log_level\s*=\).*$/\1 :warn/' \
		config/environments/production.rb

	# This is not needed, the secret_token is generated by the
	# gitlab-shell package. It also makes problems in the build phase.
	rm config/initializers/gitlab_shell_secret_token.rb

	# Remove some useless configs.
	rm config/aws.yml.example \
		config/database.yml.env \
		config/database.yml.mysql \
		config/karma.config.js \
		config/unicorn.rb.example.development \
		config/environments/development.rb \
		config/environments/test.rb

	# Remove all locale files except en.
	find locale -type d -mindepth 1 ! -name en -exec rm -rf {} +

	# This Google gem is totally messed, so we can't install it from
	# RubyGems using Bundler.
	mkdir -p vendor/gems/grpc
	cp -r "$sysgemdir"/gems/grpc-*/* vendor/gems/grpc/
	cp "$sysgemdir"/specifications/grpc-*.gemspec \
			vendor/gems/grpc/grpc.gemspec
	cp "$sysgemdir"/extensions/*/*/grpc-*/grpc/grpc_c.so \
		vendor/gems/grpc/src/ruby/lib/grpc/

	# Update bundled KaTeX
	sed -e 's|fonts/||' -e 's/url\(([^)]*)\)/url(font-path\1)/g' \
		"$srcdir"/katex/katex.css > vendor/assets/stylesheets/katex.scss
	cp "$srcdir"/katex/katex.js vendor/assets/javascripts/
	cp "$srcdir"/katex/fonts/* vendor/assets/fonts/
}

build() {
	local bundle="bundle$_rubyslot"
	local bundle_opts="--deployment --jobs=${JOBS:-2} --no-cache
		--without exclude development kerberos metrics mysql test"

	cd "$builddir"

	msg "Installing Ruby gems..."
	$bundle config build.nokogiri --use-system-libraries
	$bundle config build.rugged --use-system-libraries
	$bundle $bundle_opts

	# Patch installed gem gitlab-markup to use python3.
	# Option "-S" causes that Python cannot find docutils module.
	sed -i 's/python2 -S/python3/g' \
		vendor/bundle/ruby/*/gems/gitlab-markup-*/lib/github/markups.rb

	msg "Installing npm modules..."
	yarn install --production --frozen-lockfile --build-from-source


	# Since we have moved assets gems into a group, they are not implicitly
	# loaded by default. This will be reverted after compiling assets.
	sed -i.bak '/Bundler.require(:default, Rails.env/s/)/, :assets)/' \
		config/application.rb

	# assets:precompile and gettext:compile bootstraps the app,
	# so they needs configs.
	cp config/gitlab.yml.example config/gitlab.yml
	cp config/database.yml.postgresql config/database.yml

	# The configured path is not readable for the user building
	# the package, so we must remove it; GitLab will use the default path.
	sed -i '/^\s*secret_file:.*/d' config/gitlab.yml

	(
		export NODE_ENV=production
		export RAILS_ENV=production
		export SECRET_KEY_BASE="top-secret"
		export SKIP_STORAGE_VALIDATION=true
		export USE_DB=false

		msg "Compiling assets (this will take few minutes)..."
		$bundle exec rake gitlab:assets:compile

		msg "Compiling GetText PO files..."
		$bundle exec rake gettext:compile
	)

	# Revert changes.
	mv config/application.rb.bak config/application.rb

	msg "Cleaning assets gems..."
	$bundle $bundle_opts assets --clean

	# Create executables in bin/*.
	$bundle binstubs --force mail_room sidekiq unicorn

	# When GitLab executes a system command, it leaks some Bundler
	# env. variables. The problem may occur when it execute a Ruby script
	# with shebang "/usr/bin/env ruby"; Bundler tries to initialize GitLab
	# environments, but due to different Ruby versions it doesn't see its
	# gems. The workaround is to symlink ruby -> ruby2.1 to $_prefix/bin
	# and add it to the PATH.
	#local file; for file in bin/*; do
	#	[ -f $file ] || continue
	#	# Add text after the first line of the file.
	#	sed -i "1a ENV['PATH'] = \"#{__dir__}:#{ENV['PATH']}\"" $file
	#done

	# Cleanup
	rm config/database.yml config/gitlab.yml config/secrets.yml
}

package() {
	local destdir="${pkgdir}$_prefix"
	local datadir="$pkgdir/var/lib/gitlab"
	local file dest

	cd "$builddir"

	install -d -m755 "$destdir" "$destdir"/bin

	install -d -m755 -o git -g git \
		"$datadir" \
		"$pkgdir"/etc/gitlab \
		"$pkgdir"/var/log/gitlab \
		"$datadir"/pages

	install -d -m700 -o git -g git \
		"$datadir"/artifacts \
		"$datadir"/builds \
		"$datadir"/lfs-objects \
		"$datadir"/registry \
		"$datadir"/uploads \
		"$pkgdir"/var/tmp/gitlab/downloads \
		"$pkgdir"/var/tmp/gitlab/backups

	install -d -m02770 -o git -g git \
		"$datadir"/repositories

	# Install application files.
	# Note: *VERSION files and doc directory are required (Help in GitLab
	# menu refers to the doc directory).
	cp -rl .bundle config.ru Gemfile* Rakefile *VERSION app db doc \
		fixtures config lib locale public vendor \
		"$destdir"/

	install -m755 -t "$destdir"/bin \
		bin/bundle bin/mail_room bin/rails bin/rake \
		bin/sidekiq bin/unicorn_rails


	cd "$destdir"

	# Not needed in runtime since we have already compiled all assets.
	rm -R app/assets vendor/assets

	rm -r lib/support db/fixtures/development
	find lib/tasks -maxdepth 1 -type f ! -name cache.rake ! -name setup.rake -delete
	find lib/tasks/gitlab \
		-name 'generate_docs.*' -delete \
		-o -name 'shell.*' -delete \
		-o -name 'test.*' -delete

	cd "$destdir"/vendor/bundle/ruby/*/

	# Remove documentations and other unused textual files.
	find gems/ -name 'doc' -type d -exec rm -frv "{}" +
	find gems/ \
		-name 'README*' -delete \
		-o -name 'CHANGELOG*' -delete \
		-o -name 'CONTRIBUT*' -delete \
		-o -name '*LICENSE*' -delete

	# Remove bundled libgit2 sources.
	rm -R gems/rugged-*/vendor/libgit2

	# Remove assets, they are already compiled.
	rm -R gems/gemojione-*/assets

	# Remove sources and binaries of native extensions (they are installed
	# in extensions directory).
	find gems/ -type d -name ext -maxdepth 2 -exec rm -frv "{}" +
	find gems/ -name '*.so' -delete

	# Remove build logs and cache.
	rm -Rf build_info/ cache/
	find extensions/ \
		-name gem_make.out -delete \
		-o -name mkmf.log -delete


	cd "$destdir"

	mv config/unicorn.rb.example config/unicorn.rb

	# Just to unify for the next loop...
	mv config/sidekiq_queues.yml config/sidekiq_queues.yml.orig

	# Install and symlink config files.
	for file in database.yml.postgresql \
			gitlab.yml.example \
			resque.yml.example \
			sidekiq.yml.example \
			sidekiq_queues.yml.orig \
			initializers/rack_attack.rb.example \
			initializers/smtp_settings.rb.sample; do
		dest="$(basename "${file%.*}")"
		install -m640 -g git -D config/$file "$pkgdir"/etc/gitlab/$dest
		ln -sf /etc/gitlab/$dest "$pkgdir"$_prefix/config/${file%.*}
	done

	# This file will be generated by the post-install script, just prepare symlink.
	ln -sf /etc/gitlab/secrets.yml config/secrets.yml

	cat > "$datadir"/.profile <<-EOF
		export RAILS_ENV=production
		export NODE_ENV=production
		export EXECJS_RUNTIME=Disabled
	EOF

	# Some paths are hard-coded in GitLab, so we must make symlinks. :(
	ln -sf /var/lib/gitlab/uploads public/uploads
	ln -sf /var/log/gitlab log
	ln -sf /tmp/gitlab tmp
	ln -sf ../../tmp/gitlab "$datadir"/tmp

	# See the last comment in the build() function.
	#ln -sf /usr/bin/ruby$_rubyslot bin/ruby

	# Install wrapper scripts to /usr/bin.
	local name; for name in rake rails; do
		sed "s/__COMMAND__/$name/g" "$srcdir"/bin-wrapper.in \
			> "$builddir"/gitlab-$name
		install -m755 -D "$builddir"/gitlab-$name "$pkgdir"/usr/bin/gitlab-$name
	done

	for file in $_pkgname $_pkgname.sidekiq $_pkgname.mailroom; do
		install -m755 -D "$srcdir"/$file.initd "$pkgdir"/etc/init.d/$file
	done

	install -m644 -D "$srcdir"/$_pkgname.confd \
		"$pkgdir"/etc/conf.d/$_pkgname

	install -m644 -D "$srcdir"/$_pkgname.logrotate \
		"$pkgdir"/etc/logrotate.d/$_pkgname
}

assets() {
	depends=""
	local destdir="${subpkgdir}$_prefix"

	install -dm755 "$destdir"/public
	mv "${pkgdir}$_prefix"/public/assets "$destdir"/public/
}

sha512sums="5187ade5c85a30f32abb24e1a33cde638ab64b0a95e3c32a6bc6b83b3aa2cd24cf0f02629bb052f59bca99e7f1e20d680217f224616d7e6ffbcf6f3f185a093c  gitlab-ce-9.4.7.tar.gz
4c1865059860b2e0c1d3d1cda47c3eb9d2fa089d203f35daa5928f33064dd74f86cf1999028bd4a8de4151855b15b619161babfe2a438a0938778522a84a0083  katex-0.8.3.tar.gz
31c65c03a8e4fd1cd0f4e95939137404b96a2551d228e7d5bc0e47cc9cb3893e46e2a58405aba1ce04584a6f64120162db3e5ecd0713bb7ec9256308cafaf187  gitlab.initd
d56587e94db0f607d4d37dbc1952914e2d6628405b3c2fe9f7548f27ca70f5393bf4fdebc7fa192b9bad7d07706a55cd77a910bd127236422f0f6d4a5a46be25  gitlab.mailroom.initd
84c51a03e938c39b3081cb55b115148e087a1f58a4b9cc43b76be93aee67b7e04f41f42e6594d5810946a701cf3554ac26851b2f9de91e73927e7ef70945e2ba  gitlab.sidekiq.initd
2b771e23326c5e4f590ea1ba5e12bd44d3d6d6515edf8a79cf2722fb7d3968e60887c4b085a474100ac7562f645bff06b8a085755acd4ce533c5837392e749f2  gitlab.confd
d711d9c0a17a8a6f862f5505da1eb65a701917155207b5864b40e8acfaf958c68a2d8f9b01a92871b3d630e00c78df38b24701e4adcba8f1d35cdc69dedf2df6  gitlab.logrotate
a944c3886388ba1574bf8c96b6de4d9f24ef4a83f553c31a224e17a3b01f2a5c65b60c59b7ed7ca4b25670c60ea8dd41b96a8a623d909d2bb09bdf2520ed7f23  bin-wrapper.in
1c8562768e49c2fd97b20a1c28fd175c355d5f5bad949d1e7b72e004cd5aee57fa68cfa457a286055b8bcfe2095c7f297c2a348c49694370c4be2004a98f9930  gemfile-exclude-unnecessary-gems.patch
313262ed9bdf6b742c91e60ec6b27d64084b7bbb2569fb001660ff1d54513e5bf3f278774ca683fc594d0e49d4b9e93303d2d06d80c1e36fc2961e9a96bc540d  default-configs.patch
a7d85acec2486f2292fc5af03b4fa04be1d65e030acc7fab4f33b343a3ac09ecb7bbd9c7e13ed65f6d68293207b0804ea117156594a146fa467b4574c7da0179  dont-dump-schema.patch
71b5cd6f57cb3b722e8528a5b1fe1fad739bbf146671e90e9be176aaa7eb584f7674b7382c38e469921ea90a3381807cf41d5a59840a1c0c468f24de5da9cfa7  fix-setup-task.patch
54b684460efadc2bebe97f55a72623fa4c6d5e20e8b838eb16031a57275a2b726696baecc0e9f41dc486e3518088bb1030600571b24093f69d7a69ecb754a3f1  fix-check-task.patch
b6580385ea9900e26ae4b594699c68da90241ab466a3ec1567b33362cdd92ff3ed972eed562753b1d1f80c1fd0cb6ae7fecb83990f6a9e904b075e7ee025fe57  replace-sys-filesystem.patch
7c3cafc4c2e54487fe651ea3137f923d291084b03e77e855e7b5893dfab266278956f0be2b6639993c9040f5cff05a9a83afa24052f09981cfc678c7dff7ca13  gitlab-revision.patch
d6e0a20b9089da0c97bb9468cde5213c777db8e7812f99ec15645776e80a3786d44f1d20cc0798e1db1cdcd970b626d79b4357ab51bdc55d503ca1f1d7a9aa36  gemfile-use-local-grpc.patch
d23d8d0cacc1050a39ceb89ed132ae5e04d2df9c58abdea9c8bc7b95ed665b9c12a29240cf14efd6492fa5960f7be81a7efcf6003f1b2074e80b0f911ac710b3  gemfile-update-asciidoctor.patch
f46b783dc0760522ad45f7f83ef2bd4f4161696413193f3bb779cfd0789e8713e3797361dc68e9e73a72dfb0531c64dba9d80f14a9d600eeadfc680abfead4ad  gemfile-update-google-protobuf.patch
98e12ad483c870dc944369c70fb3f1fea52564d03cad0865017e7247617597bd1d85318f9a5d51826a582147e9f3e3683a152ea9c773714ae7e99343ff93ca6c  asciidoc-enable-setanchors-by-default.patch
2d2ad2a1d6e4ebe9d8df5dfd11dee619dcd704063ab9fb5108dcd62e047e043d621b707f8b1012508a08dfa36594d623a34be310bf5e17422b8d63808f83630c  asciidoc-include-directive.patch
4392608507241eb318c8c42149968a85f5bc379d037612180100135be6612b7da664cef7f004412c19bd8d3c8e4040ef479bae4d4f591aef4372c198f6a7f8fb  dont-load-prometheus-when-not-installed.patch
ff84fb4ad485183a7139b269dae9a720cc24f514f1aab43e7bfd7e59a4783bb46795ff98d8c65ba1d5f6ed34c46dabfb6de2d43935a1aef98f719b0213d4d42c  asciidoctor-html5s.patch
bb1e670239d495db138fa61c8738d090a5fc76ae1a66f84bcaf9a628b838e50e45cae4db1ff0edaf24157e22b20f86f712de5545aa646a93f19b6be8d2eddc37  asciidoc-disable-html-sanitization.patch
86c80ec86abaf19cae061a13c869585b21f86875baa1c8434b7cd37078333cb70dba6884da5a63a460713915fdde5020161069e768853885b4c622f80810cecd  fix-help-page.patch
2f4350833c6e51805ae4d8a6ca6aecc9bb2ab238370cb8376cab3e30d4ec2e43c42fb41943dd37f2a5fc3f0bc0977394e22af419947d12499423023d0d1aa3ff  fix-issue-board-on-ruby2.4.patch
b353a85c9d2386f658a4b0039238479b2fa230e841dc9953d502d0d9a6dcc3117dfc2a852a9165b010eccb375c2259c5f8208a5d41321429917ce88e5190da63  fix-project-feature-being-deleted-when-updating-proj.patch
f4131dfccf0d26c5dfd09cbbcb316ff29c3f05be4bcd7141124eb4848deebc74efcdd8e632e71e7e4c07e6b391c5fd8ebdc17e507ab337980a3f0029f6dde8d2  add-migration-to-fix-corrupted-projects.patch
e6257944fdb3d6bc3d7b7aad24fa81653751ff8c6d0a2ec5eea6af564d8dc9113d24c412bff9ced8fcd1104894b57f3197a65b64766e79af80befc306102a48b  asciidoc-include-directive-2.patch
4b5b3ede16c350dbc48627186bbfeec41f0b00c15c10e43e59cd2e73d31302688de648e16e93dd61b291e09612223b6d897239f5026bb79425bd6244746027cc  asciidoc-outfilesuffix.patch
aa3d30e7ef7b3a2b87237cc7b997d9abb26bff2b664582b109813e03a9e8512f789165f642818152d0dfe366766f15ea076f1201021c314b7619c2b4b7c276eb  render-index-like-readme.patch
7ec20f56e0d717dbcb1676fb63263b4f7407555dd3ec8f1a15de74494de8e7536d84ef6ced6e3afb7fb46d71f2862f5127927edd5bd905ebcc8e7ef308c1bc94  gemfile-update-asciidoctor-1.5.7.dev.patch
3b1bd66b37b42bd501b2d7e69bd62581d355fc18d1cc03dcac3ff41ad0d717abf956ca017110bb5c1794873b579c87f9d84c37a3250c55677287ab80be87a494  katex-disable-throwOnError.patch
dfd1f030b24dfe24839719ce07ed347d4326ea43dfede5c75ccf0d4b8d3ee8f8011688e2c0e88d142fc0a6f52d4d20b2250185c95d2259ebd827b9ff190cbabd  asciidoctor-interdoc-reftext.patch
330fc1176c4cd25180037fc1c9da933b5a60922df204c6c43c3e4ba75af22eda3c1e5025cde44b5428121797d2dfbc75c6eac4cfcac49120fdb271a6581545a3  extend-api-for-protected-branches.patch
20bf65bb778a7024eba821bfa3bc7be1c6bb213b4ed6aeeb1c3e3d4d8c7d5db7fec3427ac94093a9cc04a3b6ffae50763d37f0f8935d2bdbd571a90f47c076c9  asciidoc-line-through.patch
55228b45357588cad012b2daf3a213c2e6d19639660e40ec77880a8cb26ff393309d54e6dae9181b5b1f8659ec44131884b3051dc14066775a53573367ba1a48  asciidoc-expose-metadata-as-attributes.patch"
