# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=gitlab-ce
_pkgname=${pkgname%-ce}
pkgver=8.11.8
pkgrel=1
pkgdesc="A version control for your server"
url="https://github.com/gitlabhq/gitlabhq"
arch="all"
license="MIT"
_rubyslot=""
# ruby-irb is needed only for Rails console (gitlab-rails console)
depends="$pkgname-assets ca-certificates git>=2.7.3 gitlab-shell>=3.4.0
	gitlab-workhorse>=0.7.10 http-parser libgit2>=0.24 nodejs procps
	py-docutils redis>=2.8 tzdata
	ruby$_rubyslot
	ruby$_rubyslot-io-console
	ruby$_rubyslot-bigdecimal
	ruby$_rubyslot-json
	ruby$_rubyslot-rake
	ruby$_rubyslot-irb
	ruby$_rubyslot-bundler
	"
makedepends="icu-dev libgcrypt-dev libgit2-dev>=0.24 libxml2-dev libxslt-dev
	linux-headers openssl-dev postgresql-dev>=9.1 nodejs ruby$_rubyslot-dev
	"
pkgusers="git"
pkggroups="git"
install="$pkgname.pre-install $pkgname.post-install $pkgname.post-upgrade"
subpackages="$pkgname-assets"
source="$pkgname-$pkgver.tar.gz::https://github.com/gitlabhq/gitlabhq/archive/v$pkgver.tar.gz
	$_pkgname.initd
	$_pkgname.mailroom.initd
	$_pkgname.sidekiq.initd
	$_pkgname.confd
	$_pkgname.logrotate
	bin-wrapper
	0001-Gemfile.patch
	0002-default-configs.patch
	0003-dont-dump-schema.patch
	0004-fix-setup-task.patch
	0005-fix-check-task.patch
	0006-replace-sys-filesystem.patch
	"
	# TODO update these patches
	#0007-add-mathjax-support.patch
	#0008-fix-asciidoc-headers.patch
builddir="$srcdir/gitlabhq-$pkgver"

_prefix="/usr/lib/bundles/$_pkgname"

prepare() {
	default_prepare || return 1  # apply patches

	cd "$builddir"

	# Change shebang to run with correct Ruby version.
	#local file; for file in bin/bundle bin/rails bin/rake; do
	#	sed -i "s|/usr/bin/env ruby|/usr/bin/env ruby$_rubyslot|" $file || return 1
	#done
	#sed -i "s|/usr/bin/env rake|/usr/bin/env rake$_rubyslot|" Rakefile || return 1

	# The default log level is very chatty.
	sed -i 's/^\(\s*config.log_level\s*=\).*$/\1 :warn/' \
		config/environments/production.rb || return 1

	# This is not needed, the secret_token is generated by the
	# gitlab-shell package. It also makes problems in the build phase.
	rm config/initializers/gitlab_shell_secret_token.rb

	# Remove some useless configs.
	rm config/aws.yml.example \
		config/database.yml.mysql \
		config/newrelic.yml \
		config/unicorn.rb.example.development
}

build() {
	local bundle="bundle$_rubyslot"
	local cpus="$(grep -c ^processor /proc/cpuinfo || echo 1)"
	local bundle_opts="--deployment --jobs=$cpus --no-cache
		--without exclude auth-ext fog development kerberos metrics mysql test"

	cd "$builddir"

	msg "Installing Ruby gems..."

	$bundle config build.nokogiri --use-system-libraries
	$bundle config build.rugged --use-system-libraries

	$bundle $bundle_opts || return 1

	msg "Compiling assets (this will take few minutes)..."

	# Since we have moved assets gems into a group, they are not implicitly
	# loaded by default. This will be reverted after compiling assets.
	sed -i.bak '/Bundler.require(:default, Rails.env/s/)/, :assets)/' \
		config/application.rb || return 1

	# assets:precompile bootstraps the app, so it needs a config file.
	cp config/gitlab.yml.example config/gitlab.yml || return 1

	# The configured path is not readable for the user building
	# the package, so we must remove it; GitLab will use the default path.
	sed -i '/^\s*secret_file:.*/d' config/gitlab.yml || return 1

	# We must set database URL, but it's not needed to be actually
	# accessible, so just provide some dummy URL.
	DATABASE_URL="postgres://user:pass@127.0.0.1/dummy" \
		RAILS_ENV=production \
		SECRET_KEY_BASE="top-secret" \
		SKIP_STORAGE_VALIDATION=true \
		USE_DB=false \
		$bundle exec rake assets:precompile || return 1

	mv config/application.rb.bak config/application.rb || return 1

	msg "Cleaning assets gems..."

	$bundle $bundle_opts assets --clean || return 1

	# Create executables in bin/*.
	$bundle binstubs --force mail_room sidekiq unicorn || return 1

	# When GitLab executes a system command, it leaks some Bundler
	# env. variables. The problem may occur when it execute a Ruby script
	# with shebang "/usr/bin/env ruby"; Bundler tries to initialize GitLab
	# environments, but due to different Ruby versions it doesn't see its
	# gems. The workaround is to symlink ruby -> ruby2.1 to $_prefix/bin
	# and add it to the PATH.
	#local file; for file in bin/*; do
	#	[ -f $file ] || continue
	#	# Add text after the first line of the file.
	#	sed -i "1a ENV['PATH'] = \"#{__dir__}:#{ENV['PATH']}\"" $file || return 1
	#done

	# Cleanup
	rm config/gitlab.yml config/secrets.yml
	rm -R vendor/bundle/ruby/*/cache/
	rm -R vendor/bundle/ruby/*/build_info
}

package() {
	local destdir="${pkgdir}$_prefix"
	local datadir="$pkgdir/var/lib/gitlab"
	local file dest

	cd "$builddir"

	install -d -m755 "$destdir" "$destdir"/bin

	install -d -m755 -o git -g git \
		"$datadir" \
		"$pkgdir"/etc/gitlab \
		"$pkgdir"/var/log/gitlab || return 1

	install -d -m700 -o git -g git \
		"$datadir"/artifacts \
		"$datadir"/builds \
		"$datadir"/lfs-objects \
		"$datadir"/registry \
		"$datadir"/uploads || return 1

	install -d -m02770 -o git -g git \
		"$datadir"/repositories || return 1

	# Remove some useless files before copying.
	rm -r lib/support db/fixtures/development db/fixtures/test
	find lib/tasks -maxdepth 1 -type f ! -name cache.rake ! -name setup.rake -delete
	find lib/tasks/gitlab -name generate_docs.* -o -name shell.* -o -name test.* -delete

	mv config/unicorn.rb.example config/unicorn.rb || return 1

	# Install application files.
	# Note: *VERSION files and doc directory are required (Help in GitLab
	# menu refers to the doc directory).
	cp -rl .bundle config.ru Gemfile* GITLAB_SHELL_VERSION GITLAB_WORKHORSE_VERSION \
		Rakefile VERSION app db doc fixtures config lib public vendor \
		"$destdir"/ || return 1

	install -m755 -t "$destdir"/bin \
		bin/bundle bin/mail_room bin/rails bin/rake \
		bin/sidekiq bin/unicorn_rails || return 1

	# Install and symlink config files.
	for file in database.yml.postgresql \
			gitlab.yml.example \
			resque.yml.example \
			sidekiq.yml.example \
			initializers/rack_attack.rb.example \
			initializers/smtp_settings.rb.sample; do
		dest="$(basename "${file%.*}")"
		install -m640 -g git -D config/$file "$pkgdir"/etc/gitlab/$dest || return 1
		ln -sf /etc/gitlab/$dest "$pkgdir"$_prefix/config/${file%.*} || return 1
	done

	# This file will be generated by the post-install script, just prepare symlink.
	ln -sf /etc/gitlab/secrets.yml "$destdir"/config/secrets.yml || return 1

	echo "export RAILS_ENV=production" > "$datadir"/.profile

	# Some paths are hard-coded in GitLab, so we must make symlinks. :(
	ln -sf /var/lib/gitlab/uploads "$destdir"/public/uploads || return 1
	ln -sf /var/log/gitlab "$destdir"/log || return 1
	ln -sf /tmp/gitlab "$destdir"/tmp || return 1

	# See the last comment in the build() function.
	#ln -sf /usr/bin/ruby$_rubyslot "$destdir"/bin/ruby || return 1

	# Install wrapper scripts to /usr/bin.
	local name; for name in rake rails; do
		sed "s/__COMMAND__/$name/g" "$srcdir"/bin-wrapper > gitlab-$name || return 1
		install -m755 -D gitlab-$name "$pkgdir"/usr/bin/gitlab-$name || return 1
	done

	for file in $_pkgname $_pkgname.sidekiq $_pkgname.mailroom; do
		install -m755 -D "$srcdir"/$file.initd "$pkgdir"/etc/init.d/$file || return 1
	done

	install -m644 -D "$srcdir"/$_pkgname.confd \
		"$pkgdir"/etc/conf.d/$_pkgname || return 1

	install -m644 -D "$srcdir"/$_pkgname.logrotate \
		"$pkgdir"/etc/logrotate.d/$_pkgname
}

assets() {
	arch="noarch"
	depends=""
	local destdir="${subpkgdir}$_prefix"

	install -dm755 "$destdir"/public
	mv "${pkgdir}$_prefix"/public/assets "$destdir"/public/
}

md5sums="40eb32f59c88c8b42155835f3a4f8f78  gitlab-ce-8.11.8.tar.gz
39123c546b87b8383442efe542d85556  gitlab.initd
5cd94a6ac7e92b02d65126bfcaf6eb05  gitlab.mailroom.initd
c46dd56334ec024ecfcc7e7ec69f4808  gitlab.sidekiq.initd
91756c0664396ab9f76829c6567bdb94  gitlab.confd
ec823fda257d0e183f4c67e3b3f79d79  gitlab.logrotate
d3bb4776f8ecdd01d6ee3fee1d63395c  bin-wrapper
d1a1e53daa822ed7b7fc7b53afff14b0  0001-Gemfile.patch
1df8e86284e9bfcd871e0bf6d44a7755  0002-default-configs.patch
9ec230f02a0aa7350605dd8d2802d924  0003-dont-dump-schema.patch
fae44c0a7da22724a907a87c4199c300  0004-fix-setup-task.patch
ac9cb7da3cdeb056922d05b86b1df6d7  0005-fix-check-task.patch
56f86baa8b855e893fe35a833410ad85  0006-replace-sys-filesystem.patch"
sha256sums="ac1525f1f9acb57ca7ee376824c709b3f94ea7de70d389603bdbfed3a8a352a3  gitlab-ce-8.11.8.tar.gz
9f0666c4632a8a4672a58bb4b5f8b6221db342b7c4f344c03dac627d3b168658  gitlab.initd
7b1a785762dbdd5fa755ff4eeb3e2b52d6c8668833bd520ccef0561c5d497322  gitlab.mailroom.initd
952f2ce3b9c8463582acb72c0e5a1f67d2a3829086112aa81ec0dfed6524f1fe  gitlab.sidekiq.initd
ca303d9ef5a2ebc9c193f418a0e096677d5fa2ce8dead3c48075ea01bf1c71cb  gitlab.confd
13cb9f7a9f260e10d992dba4dc1b272ce9629af779cede349c059b80ef2416c1  gitlab.logrotate
2fa2992a4dfe5e07713b520751554a0b69cec499674e3a65688979b8e30e83b7  bin-wrapper
8923c383386c5d8e8b65f1731d8630329112d4c7ad04bce17830b2e0a0e3c6f0  0001-Gemfile.patch
30e58897b89645c077e8870ed9bc97fca9ba060cd14759b22cb9d798aa4a7250  0002-default-configs.patch
c84cb62eebe4784afc715bfbbbe51494261f9495c6d72e15aa4a66b132745559  0003-dont-dump-schema.patch
29e37d0d76a1e66f0ebe607e843ccd46f3b7b380619cea9ffe29a0da2b638429  0004-fix-setup-task.patch
d2ae2c2c8229606ca109b39e5f43bce528534a8d50babe1ec77bbedc5799d20c  0005-fix-check-task.patch
5668c541eb85f21d9d6cae027425b657e3d31a65d433452199c51f141aa43ed0  0006-replace-sys-filesystem.patch"
sha512sums="e7564d49f17b889539a1b61b75ec6ec032877804d123df649a31c7f4cb0cd1b1cc0bf9d29a02e85a6e7772941ff8421f49876971ee2be832516991848b3badaf  gitlab-ce-8.11.8.tar.gz
a043a21660611ea94bb59a67399a2f84fd4ca2afd8d2ae12f375c32b774c8329b714904430c0772e8844348bdae6b1338e92606e8b9baad8956a255b54b09250  gitlab.initd
d56587e94db0f607d4d37dbc1952914e2d6628405b3c2fe9f7548f27ca70f5393bf4fdebc7fa192b9bad7d07706a55cd77a910bd127236422f0f6d4a5a46be25  gitlab.mailroom.initd
705a05d7a1e1d01a83845d483d65ffd2bf1c5c9f3186f78bfe8cd515efda7452f74a5ce92be9373be5a1cf6bedb583ba545821cecdb43f42859644cf8fab78b2  gitlab.sidekiq.initd
a162412e9df709ab48cb223097c0f39dd58735a4a6f93c97686bc73727834f7ff437a573a24ff6229e4447fff0c0398d362281f3274ad28426f7054bfe3c5ba1  gitlab.confd
d711d9c0a17a8a6f862f5505da1eb65a701917155207b5864b40e8acfaf958c68a2d8f9b01a92871b3d630e00c78df38b24701e4adcba8f1d35cdc69dedf2df6  gitlab.logrotate
aff81967c19213a79f752fc3b79fac63d5ca8b68716c09542fda776355b12b85cae166966b96d64c8085254b9dc85e19d0b664cd93e1aaa01f7da89b0a4b6a8e  bin-wrapper
7d7c4b2503ed4d77912d4b6ce3a8dd57c04c28ff5d82d02efc89f094b54f5c76fb57f19bae60792450aac55f2f7d61927083ad06c8380110d925746ee2e14e4d  0001-Gemfile.patch
f003339ef3041398b8e240deac4fbffdd71cf280ed9ad1d2b2a4943096d425864891d9cf7deeb7a9d57798b7f25b04f21fc06558062e41ee0f9ab0705a6f6b5f  0002-default-configs.patch
5fe15dae9b27641dafdefa44e8a31a0b9fbcb2b3485fe0691fe60016e7bc646edf79d204068555699e18e9b643f9ea05dec0919333a3c4999381eff62df00a75  0003-dont-dump-schema.patch
ae798cdbc5e3292cc874a4bb8aee56f489abd2de1d33333fe2638f7a6bca768be08151d492532d606ee65de2931687b4ada164890efb670e91e84fbdc5098a91  0004-fix-setup-task.patch
7378b4d1745ba75111e3c11218f7f89c047ecd4b663a85484095448daacc991ec1df924177261e286abafc02c39894bceafc2a0aad97c99dea63ec342610255b  0005-fix-check-task.patch
7a2745d21d9d00dd60f9e22010d2417a2b561b93540581c411ee64592a55154f59259ef7e1969b548100e26b2d55ce2e4e4c698f630c1f27439898afd12e5d1e  0006-replace-sys-filesystem.patch"
