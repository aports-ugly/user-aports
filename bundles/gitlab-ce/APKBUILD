# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=gitlab-ce
_pkgname=${pkgname%-ce}
pkgver=10.4.6
pkgrel=0
pkgdesc="A version control for your server"
url="https://gitlab.com/gitlab-org/gitlab-ce"
arch="all"
license="MIT"
_rubyslot=""
# ruby-irb is needed only for Rails console (gitlab-rails console)
depends="$pkgname-assets=$pkgver-r$pkgrel
	gitaly>=0.66.0
	gitlab-shell>=5.11.0
	gitlab-workhorse>=3.3.1
	ca-certificates
	git>=2.8.3
	http-parser
	libgit2=~0.26
	procps
	py-docutils
	python3
	redis>=2.8
	tzdata
	ruby$_rubyslot
	ruby$_rubyslot-io-console
	ruby$_rubyslot-bigdecimal
	ruby$_rubyslot-json
	ruby$_rubyslot-rake
	ruby$_rubyslot-irb
	ruby$_rubyslot-bundler>=1.15.4
	"
makedepends="
	gpgme-dev
	icu-dev
	libffi-dev
	libgcrypt-dev
	libgit2-dev>=0.25
	libxml2-dev
	libxslt-dev
	linux-headers
	libressl-dev
	postgresql-dev
	protobuf-dev
	nodejs>=6.0.0
	re2-dev
	ruby$_rubyslot-dev
	ruby$_rubyslot-grpc
	yarn>=0.17.0
	"
pkgusers="git"
pkggroups="git"
install="$pkgname.pre-install $pkgname.post-install $pkgname.post-upgrade"
subpackages="$pkgname-assets::noarch"
# NOTE: Patches are exported from https://github.com/jirutka/gitlabhq/tree/10-4-stable
source="$pkgname-$pkgver.tar.gz::https://github.com/gitlabhq/gitlabhq/archive/v$pkgver.tar.gz
	$_pkgname.initd
	$_pkgname.mailroom.initd
	$_pkgname.sidekiq.initd
	$_pkgname.confd
	$_pkgname.logrotate
	bin-wrapper.in
	0001-Move-some-unnecessary-gems-to-groups-i.e.-exclude-th.patch
	0002-Adjust-paths-and-remove-some-boilerplate-from-config.patch
	0003-Disable-dumping-schema.rb-after-db-migrate.patch
	0004-Fix-gitlab-setup-task-to-not-drop-create-database.patch
	0005-Disable-checking-init-script-in-gitlab-check-task.patch
	0006-Replace-Sys-Filesystem-with-non-FFI-code.patch
	0007-Don-t-read-GitLab-revision-using-git.patch
	0008-Don-t-fetch-grpc-gem-from-RubyGems.patch
	0009-Don-t-load-prometheus-when-not-installed-enabled.patch
	0010-Fix-help-page.patch
	0011-Disable-throwOnError-in-KaTeX-to-reveal-user-where-i.patch
	0012-Update-asciidoctor-to-1.5.6.2.patch
	0013-Set-Asciidoctor-outfilesuffix-to-default-.adoc.patch
	0014-Enable-Asciidoctor-s-attribute-sectanchors-by-defaul.patch
	0015-Significantly-improve-AsciiDoc-rendering.patch
	0016-Disable-HTML-sanitization-filter-for-AsciiDoc.patch
	0017-Add-support-for-AsciiDoc-include-directive.patch
	0018-Change-Asciidoctor-safe-level-to-server.patch
	0019-Render-index.-like-README.-when-it-s-present-in-a-di.patch
	0020-Refactor-Gitlab-Asciidoc-prepare-it-for-more-extensi.patch
	0021-Integrate-Asciidoctor-extension-interdoc-reftext.patch
	0022-Expose-some-project-metadata-as-AsciiDoc-attributes.patch
	0023-Make-support-of-ED25519-SSH-host-key-support-optiona.patch
	0024-Don-t-eager-load-google-apis.patch
	0025-Disable-Auto-DevOps-banner-completely.patch
	"
builddir="$srcdir/gitlabhq-$pkgver"

_prefix="/usr/lib/bundles/$_pkgname"

prepare() {
	local sysgemdir=$(ruby$_rubyslot -rubygems -e 'puts Gem.default_dir')

	default_prepare

	cd "$builddir"

	# Change shebang to run with correct Ruby version.
	#local file; for file in bin/bundle bin/rails bin/rake; do
	#	sed -i "s|/usr/bin/env ruby|/usr/bin/env ruby$_rubyslot|" $file
	#done
	#sed -i "s|/usr/bin/env rake|/usr/bin/env rake$_rubyslot|" Rakefile

	# The default log level is very chatty.
	sed -i 's/^\(\s*config.log_level\s*=\).*$/\1 :warn/' \
		config/environments/production.rb

	# This is not needed, the secret_token is generated by the
	# gitlab-shell package. It also makes problems in the build phase.
	rm config/initializers/gitlab_shell_secret_token.rb

	# Remove some useless configs.
	rm config/aws.yml.example \
		config/database.yml.env \
		config/database.yml.mysql \
		config/karma.config.js \
		config/unicorn.rb.example.development \
		config/environments/development.rb \
		config/environments/test.rb

	# Remove all locale files except en.
	find locale -type d -mindepth 1 ! -name en -exec rm -rf {} +

	# This Google gem is totally messed, so we can't install it from
	# RubyGems using Bundler.
	mkdir -p vendor/gems/grpc
	cp -r "$sysgemdir"/gems/grpc-*/* vendor/gems/grpc/
	cp "$sysgemdir"/specifications/grpc-*.gemspec \
			vendor/gems/grpc/grpc.gemspec
	cp "$sysgemdir"/extensions/*/*/grpc-*/grpc/grpc_c.so \
		vendor/gems/grpc/src/ruby/lib/grpc/
}

build() {
	local bundle="bundle$_rubyslot"
	# ed25519 is excluded mainly because it depends on rbnacl that requires ffi.
	local bundle_opts="--deployment --jobs=${JOBS:-2} --no-cache
		--without ed25519 exclude development kerberos metrics mysql test"

	cd "$builddir"

	msg "Installing Ruby gems..."
	$bundle config build.nokogiri --use-system-libraries
	$bundle config build.rugged --use-system-libraries
	$bundle config build.gpgme --use-system-libraries
	$bundle $bundle_opts

	# Patch installed gem gitlab-markup to use python3.
	# Option "-S" causes that Python cannot find docutils module.
	sed -i 's/python2 -S/python3/g' \
		vendor/bundle/ruby/*/gems/gitlab-markup-*/lib/github/markups.rb

	msg "Installing npm modules..."
	yarn install --production --pure-lockfile


	# Since we have moved assets gems into a group, they are not implicitly
	# loaded by default. This will be reverted after compiling assets.
	sed -i.bak '/Bundler.require(:default, Rails.env/s/)/, :assets)/' \
		config/application.rb

	# assets:precompile and gettext:compile bootstraps the app,
	# so they needs configs.
	cp config/gitlab.yml.example config/gitlab.yml
	cp config/database.yml.postgresql config/database.yml

	# The configured path is not readable for the user building
	# the package, so we must remove it; GitLab will use the default path.
	sed -i '/^\s*secret_file:.*/d' config/gitlab.yml

	(
		export NODE_ENV=production
		export RAILS_ENV=production
		export SECRET_KEY_BASE="top-secret"
		export SKIP_STORAGE_VALIDATION=true
		export USE_DB=false

		msg "Compiling assets (this will take few minutes)..."
		$bundle exec rake gitlab:assets:compile

		msg "Compiling GetText PO files..."
		$bundle exec rake gettext:compile
	)

	# Revert changes.
	mv config/application.rb.bak config/application.rb

	msg "Cleaning assets gems..."
	$bundle $bundle_opts assets --clean

	# Create executables in bin/*.
	# See also https://github.com/bundler/bundler/issues/6149.
	$bundle binstubs --force bundler mail_room sidekiq unicorn

	# When GitLab executes a system command, it leaks some Bundler
	# env. variables. The problem may occur when it execute a Ruby script
	# with shebang "/usr/bin/env ruby"; Bundler tries to initialize GitLab
	# environments, but due to different Ruby versions it doesn't see its
	# gems. The workaround is to symlink ruby -> ruby2.1 to $_prefix/bin
	# and add it to the PATH.
	#local file; for file in bin/*; do
	#	[ -f $file ] || continue
	#	# Add text after the first line of the file.
	#	sed -i "1a ENV['PATH'] = \"#{__dir__}:#{ENV['PATH']}\"" $file
	#done

	# Cleanup
	rm config/database.yml config/gitlab.yml config/secrets.yml
}

package() {
	local destdir="${pkgdir}$_prefix"
	local datadir="$pkgdir/var/lib/gitlab"
	local file dest

	cd "$builddir"

	install -d -m755 "$destdir" "$destdir"/bin

	install -d -m755 -o git -g git \
		"$datadir" \
		"$pkgdir"/etc/gitlab \
		"$pkgdir"/var/log/gitlab \
		"$datadir"/pages

	install -d -m700 -o git -g git \
		"$datadir"/artifacts \
		"$datadir"/builds \
		"$datadir"/lfs-objects \
		"$datadir"/registry \
		"$datadir"/uploads \
		"$pkgdir"/var/tmp/gitlab/downloads \
		"$pkgdir"/var/tmp/gitlab/backups

	install -d -m02770 -o git -g git \
		"$datadir"/repositories

	# Install application files.
	# Note: *VERSION files and doc directory are required (Help in GitLab
	# menu refers to the doc directory).
	cp -rl .bundle config.ru Gemfile* Rakefile *VERSION app db doc \
		fixtures config lib locale public vendor \
		"$destdir"/

	install -m755 -t "$destdir"/bin \
		bin/bundle bin/mail_room bin/rails bin/rake \
		bin/sidekiq bin/unicorn_rails


	cd "$destdir"

	# Not needed in runtime since we have already compiled all assets.
	rm -R app/assets vendor/assets

	rm -r lib/support db/fixtures/development
	find lib/tasks -maxdepth 1 -type f ! -name cache.rake ! -name setup.rake -delete
	find lib/tasks/gitlab \( -name 'generate_docs.*' \
	                      -o -name 'shell.*' \
	                      -o -name 'test.*' \) -delete

	cd "$destdir"/vendor/bundle/ruby/*/

	# Remove documentations and other unused textual files.
	find gems/ -name 'doc' -type d -exec rm -frv "{}" +
	find gems/ \( -name 'README*' \
	           -o -name 'CHANGELOG*' \
	           -o -name 'CONTRIBUT*' \
	           -o -name '*LICENSE*' \) -delete

	# Remove bundled libgit2 sources.
	rm -R gems/rugged-*/vendor/libgit2

	# Remove assets, they are already compiled.
	rm -R gems/gemojione-*/assets

	# Remove sources and binaries of native extensions (they are installed
	# in extensions directory).
	find gems/ -type d -name ext -maxdepth 2 -exec rm -frv "{}" +
	find gems/ -name '*.so' -delete

	# Remove build logs and cache.
	rm -Rf build_info/ cache/
	find extensions/ \( -name gem_make.out -o -name mkmf.log \) -delete


	cd "$destdir"

	mv config/unicorn.rb.example config/unicorn.rb

	# Just to unify for the next loop...
	mv config/sidekiq_queues.yml config/sidekiq_queues.yml.orig

	# Install and symlink config files.
	for file in database.yml.postgresql \
			gitlab.yml.example \
			resque.yml.example \
			sidekiq.yml.example \
			sidekiq_queues.yml.orig \
			initializers/rack_attack.rb.example \
			initializers/smtp_settings.rb.sample; do
		dest="$(basename "${file%.*}")"
		install -m640 -g git -D config/$file "$pkgdir"/etc/gitlab/$dest
		ln -sf /etc/gitlab/$dest "$pkgdir"$_prefix/config/${file%.*}
	done

	# This file will be generated by the post-install script, just prepare symlink.
	ln -sf /etc/gitlab/secrets.yml config/secrets.yml

	cat > "$datadir"/.profile <<-EOF
		export RAILS_ENV=production
		export NODE_ENV=production
		export EXECJS_RUNTIME=Disabled
	EOF

	# Some paths are hard-coded in GitLab, so we must make symlinks. :(
	ln -sf /var/lib/gitlab/uploads public/uploads
	ln -sf /var/log/gitlab log
	ln -sf /tmp/gitlab tmp

	# See the last comment in the build() function.
	#ln -sf /usr/bin/ruby$_rubyslot bin/ruby

	# Install wrapper scripts to /usr/bin.
	local name; for name in rake rails; do
		sed "s/__COMMAND__/$name/g" "$srcdir"/bin-wrapper.in \
			> "$builddir"/gitlab-$name
		install -m755 -D "$builddir"/gitlab-$name "$pkgdir"/usr/bin/gitlab-$name
	done

	for file in $_pkgname $_pkgname.sidekiq $_pkgname.mailroom; do
		install -m755 -D "$srcdir"/$file.initd "$pkgdir"/etc/init.d/$file
	done

	install -m644 -D "$srcdir"/$_pkgname.confd \
		"$pkgdir"/etc/conf.d/$_pkgname

	install -m644 -D "$srcdir"/$_pkgname.logrotate \
		"$pkgdir"/etc/logrotate.d/$_pkgname
}

assets() {
	depends=""
	local destdir="${subpkgdir}$_prefix"

	install -dm755 "$destdir"/public
	mv "${pkgdir}$_prefix"/public/assets "$destdir"/public/
}

sha512sums="2001ec6bf272c36d411908bb43c19e4cf73a12daf546f8d5e1f76309c16ac9168e7953e1ff8d002c36f5249960a66a4fcebefdc47075880dcc11772d9cdef267  gitlab-ce-10.4.6.tar.gz
31c65c03a8e4fd1cd0f4e95939137404b96a2551d228e7d5bc0e47cc9cb3893e46e2a58405aba1ce04584a6f64120162db3e5ecd0713bb7ec9256308cafaf187  gitlab.initd
478759565c27d7e300e69715ed069ca6689fc0f33781a99e4ca9f52a49763e3a46d6a1ca7fa61879b200156543e534f652deec1367c31a52154db6f0f8ecb779  gitlab.mailroom.initd
84c51a03e938c39b3081cb55b115148e087a1f58a4b9cc43b76be93aee67b7e04f41f42e6594d5810946a701cf3554ac26851b2f9de91e73927e7ef70945e2ba  gitlab.sidekiq.initd
2b771e23326c5e4f590ea1ba5e12bd44d3d6d6515edf8a79cf2722fb7d3968e60887c4b085a474100ac7562f645bff06b8a085755acd4ce533c5837392e749f2  gitlab.confd
d711d9c0a17a8a6f862f5505da1eb65a701917155207b5864b40e8acfaf958c68a2d8f9b01a92871b3d630e00c78df38b24701e4adcba8f1d35cdc69dedf2df6  gitlab.logrotate
a944c3886388ba1574bf8c96b6de4d9f24ef4a83f553c31a224e17a3b01f2a5c65b60c59b7ed7ca4b25670c60ea8dd41b96a8a623d909d2bb09bdf2520ed7f23  bin-wrapper.in
697679bb16212f5d2f35e4535aed706e5323ad9d63198d27101f5af4c1b4f5d5289b47b2a8c6a300e4b3ae97e849ab3930678ee296358f1504a94f07049b098b  0001-Move-some-unnecessary-gems-to-groups-i.e.-exclude-th.patch
6d21508e1f2d5511e3f3a52427f6cf767aef2a8ab76449890f94a5738f2e49adb1ecdc078e86ffd9c80c5b5c6eb755544956d4b40318416fdb8cf51f847b4724  0002-Adjust-paths-and-remove-some-boilerplate-from-config.patch
badd34be16e8d2477e52da70cd8b1bbae890db900fa517cacec13dd6a602664fc47e4c43b915a6745f7a7683d3382fcad45670c550b687db0b07e3cd995f7818  0003-Disable-dumping-schema.rb-after-db-migrate.patch
3b5c118958abeeedaa92e32bf10664abb0c3a921a93293cc2db7cd72ed4bc00b50b2971544653f0285f97e6ad473f59b37e36882c77c229813cbc22f1d3486f1  0004-Fix-gitlab-setup-task-to-not-drop-create-database.patch
7b50e495e98dd52b8d41ab7dcb956b6b101a0b47c1f153e8d28113cd8b5e777555711b0d029efb0c44cca16844a457d9e02bce17e2ba2b4db1af834aeb85bc57  0005-Disable-checking-init-script-in-gitlab-check-task.patch
199ea826fa0fbac9e818c629461020fde7aa297de4f50e4c4c394123d8e5c4106a9e91e354fbaada602b9d4b2dd1886c81d2bc676ea0be36ea66b620c2994e64  0006-Replace-Sys-Filesystem-with-non-FFI-code.patch
bb780b544624db76ab31481c2ed0655282b444eeeaa4f474481258ed018b1b91dcef5fc99a8bc14e9a4037f3ac6b1651a78cc54b6b09af64aa1852d2765b5c7b  0007-Don-t-read-GitLab-revision-using-git.patch
42f7807be322cbc2acbf52772849a5c61d72bb112ce038e1710c998d2d5b6387f6995499677648b9d889d99ea6601ef00855fe169614263679e7f81d2c5400e7  0008-Don-t-fetch-grpc-gem-from-RubyGems.patch
1c0833be92707d2b5fc6726ea87c7bee8bf0b0fe664f8fe88f7fa1b83eebbe8d5da2ccab617ac94c9b0c40cfc180bf76366ec1b9726d53fd23602c79fbb2ca83  0009-Don-t-load-prometheus-when-not-installed-enabled.patch
81820229887f2dc22a567b6bca26a7203d85edd7c5167fe9fc524555df400b32d60096d2decb8445b7fdef4383f11950942ddb1e1e42ec0f4cfa85719ffa3f4b  0010-Fix-help-page.patch
8144548311ffc37da758aaec25b898fead7e374ead0ad12532cc7f542a4f2198e119ae75a6e3a6572050afb82ed483e9debf7eff11149b6fe4cf58f19cc37cab  0011-Disable-throwOnError-in-KaTeX-to-reveal-user-where-i.patch
f805a25abbaef7b76287055c204a37126d8cbabb455a54d9022fbf5f411cc9c72f80fccdfd8ca16fe90d38d8b0a9d48c300fcf5e05b10b08340384cd2c5d7a89  0012-Update-asciidoctor-to-1.5.6.2.patch
1dfbe87cadeb027f43c784c3f686fded99e072318923b493071da71a8018e8dfcce8ddae6d153a3e80786dc48c57660cf0305174c59b531439e1d798c9d0ebf9  0013-Set-Asciidoctor-outfilesuffix-to-default-.adoc.patch
4e5491e55105a696c68ac0a816fb983b8d51a241363d9356edad574be46e911fc24b798f0e73c8195e404bafbe317a78819703ae55751e1398cc3826e463c2af  0014-Enable-Asciidoctor-s-attribute-sectanchors-by-defaul.patch
05be51a1468a4e0a36017846eb8c06167d55f2d374595e1e3d72765388514fe85157eec9156c978a479d1e87f880fd70360aa58d8f1b8506155fcfafbdbc19e0  0015-Significantly-improve-AsciiDoc-rendering.patch
05b3eb103a5f86500aebf9f3d25fbe4998b69b7668024546d25ed0198c6be6add4dc7a3b66ff533917feab83bf7fffd06ac01d138234ef5503297256650498d2  0016-Disable-HTML-sanitization-filter-for-AsciiDoc.patch
e0fbbb3980e22b2a0a9b483d3df23f5a8fc2e96dcaaeb258555dbda064d4f503e97fe545d2dcc3be8206464d0fca38d3923c81bb17d1d727ca7d16a47d744e34  0017-Add-support-for-AsciiDoc-include-directive.patch
adc9db7b0aa07c3bb3743bcfec461e2f446208440a044ae2b8f9a754eedaf1820c2583e483e72fcdaa52f4e61eebc1e4f097bc293e6d79094020dbbebcc573e3  0018-Change-Asciidoctor-safe-level-to-server.patch
74e5c14051d583db5f64f05ebfbe810658658b4fbf377a1bb27bca3c429586cfb10118a381598f9b21149c5f8d3e72cab47d4f24f736ab39211f8569c4651a50  0019-Render-index.-like-README.-when-it-s-present-in-a-di.patch
6d3feff95a595df325d3d4ede53e2cbdfad0ec3bd04af0e36ebade5e0705dc4fde8f301a279fd8b968083cd45177e7dc5e13c4073cd1b13375a6a88099961ee8  0020-Refactor-Gitlab-Asciidoc-prepare-it-for-more-extensi.patch
5aa034dfeb403c84de9dd686c76ad5b970f6c7f7bfa72f6eb5ceebab19b166dcdcd19a68cc2ca4425cd056cea119b87389a500c20d088557ce2b2a1631f6599f  0021-Integrate-Asciidoctor-extension-interdoc-reftext.patch
bdd2c6ccb8a9a4c572795398fb35dd30cfb9a4b614b50d93daf2fcb799b5896ae19b14c8ac7aa3a550cac34c492514afcb68a9e7317c44e72cb28eca80a3ca0f  0022-Expose-some-project-metadata-as-AsciiDoc-attributes.patch
8cc8131e9c3b33ee96614e6e710ec08bd8f9d45c767827e2d31cfa3b647306102f955396032cda9c60f073b9542c34e727cab2f1a53d162fd665044c0a5aedf1  0023-Make-support-of-ED25519-SSH-host-key-support-optiona.patch
9011f9e2cb699d573e83d646c61a8c8cc55771d8b9564fbf3494fdbec0cc3d501f7783d9ea93491ead56abe53bc82f413f39266112f688163d4ccbeec8c9eeb7  0024-Don-t-eager-load-google-apis.patch
69e511d7b06344f9dbf450dd945c3c64c71c7125e59cff7d091dd663c39048f5acd303ad6db634c3f51f838fdc6aa9ef3826a9e0317527d823b8d9dcfe67dff5  0025-Disable-Auto-DevOps-banner-completely.patch"
