From edc2c5d156f98fa71cc5e5895a55e2dd822d684f Mon Sep 17 00:00:00 2001
From: Stan Hu <stanhu@gmail.com>
Date: Tue, 31 Jul 2018 06:13:01 -0700
Subject: [PATCH] Fix LFS uploads not working with git-lfs 2.5.0

git-lfs 2.5.0 now sets the Content-Type header instead of hard-coding it to
application/octet-stream: https://github.com/git-lfs/git-lfs/pull/3137

To avoid this issue, we explicitly tell the client to use
application/octet-stream.

Closes #49752

Upstream-Issue: https://gitlab.com/gitlab-org/gitlab-ce/merge_requests/20923
---
 app/controllers/projects/lfs_api_controller.rb    | 7 ++++++-
 changelogs/unreleased/sh-lfs-fix-content-type.yml | 5 +++++
 spec/requests/lfs_http_spec.rb                    | 6 +++---
 3 files changed, 14 insertions(+), 4 deletions(-)
 create mode 100644 changelogs/unreleased/sh-lfs-fix-content-type.yml

diff --git a/app/controllers/projects/lfs_api_controller.rb b/app/controllers/projects/lfs_api_controller.rb
index 536f908d2c5..97db165bb40 100644
--- a/app/controllers/projects/lfs_api_controller.rb
+++ b/app/controllers/projects/lfs_api_controller.rb
@@ -1,6 +1,8 @@
 class Projects::LfsApiController < Projects::GitHttpClientController
   include LfsRequest
 
+  LFS_TRANSFER_CONTENT_TYPE = 'application/octet-stream'.freeze
+
   skip_before_action :lfs_check_access!, only: [:deprecated]
   before_action :lfs_check_batch_operation!, only: [:batch]
 
@@ -86,7 +88,10 @@ class Projects::LfsApiController < Projects::GitHttpClientController
       upload: {
         href: "#{project.http_url_to_repo}/gitlab-lfs/objects/#{object[:oid]}/#{object[:size]}",
         header: {
-          Authorization: request.headers['Authorization']
+          Authorization: request.headers['Authorization'],
+          # git-lfs v2.5.0 sets the Content-Type based on the uploaded file. This
+          # ensures that Workhorse can intercept the request.
+          'Content-Type': LFS_TRANSFER_CONTENT_TYPE
         }.compact
       }
     }
diff --git a/changelogs/unreleased/sh-lfs-fix-content-type.yml b/changelogs/unreleased/sh-lfs-fix-content-type.yml
new file mode 100644
index 00000000000..a839be9b3ae
--- /dev/null
+++ b/changelogs/unreleased/sh-lfs-fix-content-type.yml
@@ -0,0 +1,5 @@
+---
+title: Fix LFS uploads not working with git-lfs 2.5.0
+merge_request: 20923
+author:
+type: fixed
diff --git a/spec/requests/lfs_http_spec.rb b/spec/requests/lfs_http_spec.rb
index bee918a20aa..079bbce4b77 100644
--- a/spec/requests/lfs_http_spec.rb
+++ b/spec/requests/lfs_http_spec.rb
@@ -664,7 +664,7 @@ describe 'Git LFS API and storage' do
           expect(json_response['objects'].first['oid']).to eq(sample_oid)
           expect(json_response['objects'].first['size']).to eq(sample_size)
           expect(json_response['objects'].first['actions']['upload']['href']).to eq("#{Gitlab.config.gitlab.url}/#{project.full_path}.git/gitlab-lfs/objects/#{sample_oid}/#{sample_size}")
-          expect(json_response['objects'].first['actions']['upload']['header']).to eq('Authorization' => authorization)
+          expect(json_response['objects'].first['actions']['upload']['header']).to eq({ 'Authorization' => authorization, 'Content-Type' => 'application/octet-stream' })
         end
       end
 
@@ -693,7 +693,7 @@ describe 'Git LFS API and storage' do
               expect(lfs_object.projects.pluck(:id)).not_to include(project.id)
               expect(lfs_object.projects.pluck(:id)).to include(other_project.id)
               expect(json_response['objects'].first['actions']['upload']['href']).to eq("#{project.http_url_to_repo}/gitlab-lfs/objects/#{sample_oid}/#{sample_size}")
-              expect(json_response['objects'].first['actions']['upload']['header']).to eq('Authorization' => authorization)
+              expect(json_response['objects'].first['actions']['upload']['header']).to eq({ 'Authorization' => authorization, 'Content-Type' => 'application/octet-stream' })
             end
           end
 
@@ -728,7 +728,7 @@ describe 'Git LFS API and storage' do
               expect(json_response['objects'].first['oid']).to eq("91eff75a492a3ed0dfcb544d7f31326bc4014c8551849c192fd1e48d4dd2c897")
               expect(json_response['objects'].first['size']).to eq(1575078)
               expect(json_response['objects'].first['actions']['upload']['href']).to eq("#{project.http_url_to_repo}/gitlab-lfs/objects/91eff75a492a3ed0dfcb544d7f31326bc4014c8551849c192fd1e48d4dd2c897/1575078")
-              expect(json_response['objects'].first['actions']['upload']['header']).to eq("Authorization" => authorization)
+              expect(json_response['objects'].first['actions']['upload']['header']).to eq({ 'Authorization' => authorization, 'Content-Type' => 'application/octet-stream' })
 
               expect(json_response['objects'].last['oid']).to eq(sample_oid)
               expect(json_response['objects'].last['size']).to eq(sample_size)
-- 
2.16.4

