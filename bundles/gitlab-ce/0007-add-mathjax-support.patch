From 55b00c88690d7fa45b46aeffe721f9710666fb3e Mon Sep 17 00:00:00 2001
From: Jakub Jirutka <jakub@jirutka.cz>
Date: Thu, 6 Oct 2016 16:26:26 +0200
Subject: [PATCH] Add support for MathJax with AsciiDoc

Ported from https://gitlab.com/gitlab-org/gitlab-ce/merge_requests/4333

---
 app/assets/javascripts/blob_edit/edit_blob.js |  1 +
 app/assets/javascripts/mathjax.js.coffee      | 40 +++++++++++++++++++++++++++
 app/helpers/application_helper.rb             |  4 +++
 app/helpers/gitlab_markdown_helper.rb         |  2 ++
 app/helpers/page_layout_helper.rb             | 15 ++++++++++
 app/views/layouts/_page.html.haml             |  2 +-
 app/views/projects/blob/edit.html.haml        |  1 +
 config/gitlab.yml.example                     | 11 ++++++++
 config/initializers/1_settings.rb             |  1 +
 lib/gitlab/asciidoc.rb                        |  6 ++++
 lib/gitlab/gon_helper.rb                      |  1 +
 11 files changed, 83 insertions(+), 1 deletion(-)
 create mode 100644 app/assets/javascripts/mathjax.js.coffee

diff --git a/app/assets/javascripts/blob_edit/edit_blob.js b/app/assets/javascripts/blob_edit/edit_blob.js
index 649c79d..9a564ed 100644
--- a/app/assets/javascripts/blob_edit/edit_blob.js
+++ b/app/assets/javascripts/blob_edit/edit_blob.js
@@ -52,6 +52,7 @@
           content: this.editor.getValue()
         }, function(response) {
           currentPane.empty().append(response);
+          $(document).trigger('mathjax:typeset');
           return currentPane.syntaxHighlight();
         });
       } else {
diff --git a/app/assets/javascripts/mathjax.js.coffee b/app/assets/javascripts/mathjax.js.coffee
new file mode 100644
index 0000000..b37fa1c
--- /dev/null
+++ b/app/assets/javascripts/mathjax.js.coffee
@@ -0,0 +1,40 @@
+# Inspired by http://reed.github.io/turbolinks-compatibility/mathjax.html.
+
+config =
+  tex2jax:
+    inlineMath: [['\\(', '\\)']]  # default for Asciidoctor
+    displayMath: [['\\[', '\\]']]  # default for Asciidoctor
+    ignoreClass: 'page-with-sidebar|navbar|nostem|nolatexmath'
+    processClass: 'wiki'
+  asciimath2jax:
+    delimiters: [['\\$', '\\$']]  # default for Asciidoctor
+    ignoreClass: 'page-with-sidebar|navbar|nostem|nolatexmath'
+    processClass: 'wiki'
+  TeX:
+    equationNumbers:
+      autoNumber: 'none'
+
+isEnabled = ->
+  $('.content').data('mathjax') == 'enabled'
+
+load = ->
+  $.ajax(
+    dataType: 'script'
+    cache: true
+    url: "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=#{gon.mathjax_config}"
+  ).done =>
+    window.MathJax.Hub.Config(config)
+
+typeset = ->
+  window.MathJax?.Hub.Queue(['Typeset', window.MathJax.Hub])
+
+onPageLoad = ->
+  return unless isEnabled()
+  if window.MathJax
+    typeset()
+  else
+    load()
+
+$(document).ready onPageLoad
+$(document).on 'page:load', onPageLoad
+$(document).on 'mathjax:typeset', typeset
diff --git a/app/helpers/application_helper.rb b/app/helpers/application_helper.rb
index f3733b0..668f11a 100644
--- a/app/helpers/application_helper.rb
+++ b/app/helpers/application_helper.rb
@@ -231,6 +231,10 @@ module ApplicationHelper
     Gitlab::MarkupHelper.asciidoc?(filename)
   end
 
+  def contains_math?(file_name, file_content)
+    asciidoc?(file_name) && Gitlab::Asciidoc.contains_stem?(file_content)
+  end
+
   def promo_host
     'about.gitlab.com'
   end
diff --git a/app/helpers/gitlab_markdown_helper.rb b/app/helpers/gitlab_markdown_helper.rb
index 1a25965..75d124e 100644
--- a/app/helpers/gitlab_markdown_helper.rb
+++ b/app/helpers/gitlab_markdown_helper.rb
@@ -65,6 +65,8 @@ module GitlabMarkdownHelper
   end
 
   def asciidoc(text)
+    load_mathjax! if Gitlab::Asciidoc.contains_stem?(text)
+
     Gitlab::Asciidoc.render(
       text,
       project:      @project,
diff --git a/app/helpers/page_layout_helper.rb b/app/helpers/page_layout_helper.rb
index 22387d6..e7dd8fb 100644
--- a/app/helpers/page_layout_helper.rb
+++ b/app/helpers/page_layout_helper.rb
@@ -121,4 +121,19 @@ module PageLayoutHelper
 
     css_class
   end
+
+  def load_mathjax!
+    @load_mathjax = true
+  end
+
+  def load_mathjax?
+    case extra_config.fetch('mathjax_load', 'never')
+    when 'auto'
+      @load_mathjax
+    when 'always'
+      true
+    else
+      false
+    end
+  end
 end
diff --git a/app/views/layouts/_page.html.haml b/app/views/layouts/_page.html.haml
index bf50633..897e073 100644
--- a/app/views/layouts/_page.html.haml
+++ b/app/views/layouts/_page.html.haml
@@ -24,5 +24,5 @@
     = render "layouts/flash"
     = yield :flash_message
     %div{ class: "#{(container_class unless @no_container)} #{@content_class}" }
-      .content
+      %div{ class: 'content', 'data-mathjax' => ('enabled' if load_mathjax?) }
         = yield
diff --git a/app/views/projects/blob/edit.html.haml b/app/views/projects/blob/edit.html.haml
index 680e95a..b21a5ca 100644
--- a/app/views/projects/blob/edit.html.haml
+++ b/app/views/projects/blob/edit.html.haml
@@ -1,4 +1,5 @@
 - page_title "Edit", @blob.path, @ref
+- load_mathjax! if contains_math?(@blob.name, @blob.data)
 - content_for :page_specific_javascripts do
   = page_specific_javascript_tag('lib/ace.js')
   = page_specific_javascript_tag('blob_edit/blob_edit_bundle.js')
diff --git a/config/gitlab.yml.example b/config/gitlab.yml.example
index 1470a6e..70c2b0e 100644
--- a/config/gitlab.yml.example
+++ b/config/gitlab.yml.example
@@ -496,6 +496,17 @@ production: &base
     # piwik_url: '_your_piwik_url'
     # piwik_site_id: '_your_piwik_site_id'
 
+    ## MathJax
+    # Load MathJax library for typesetting math?
+    #   never  - this is default
+    #   auto   - when document declares that it contains math (depends on markup)
+    #   always -
+    # mathjax_load: auto
+    #
+    # Name of pre-defined MathJax configuration available on CDN.
+    # See http://docs.mathjax.org/en/latest/config-files.html for options.
+    # mathjax_config: TeX-MML-AM_CHTML
+
   rack_attack:
     git_basic_auth:
       # Rack Attack IP banning enabled
diff --git a/config/initializers/1_settings.rb b/config/initializers/1_settings.rb
index 4a01b9e..9c22447 100644
--- a/config/initializers/1_settings.rb
+++ b/config/initializers/1_settings.rb
@@ -372,6 +372,7 @@ Settings.satellites['path'] = File.expand_path(Settings.satellites['path'] || "t
 # Extra customization
 #
 Settings['extra'] ||= Settingslogic.new({})
+Settings.extra['mathjax_config'] ||= 'TeX-MML-AM_CHTML'
 
 #
 # Rack::Attack settings
diff --git a/lib/gitlab/asciidoc.rb b/lib/gitlab/asciidoc.rb
index 1a22ad9..33571ce 100644
--- a/lib/gitlab/asciidoc.rb
+++ b/lib/gitlab/asciidoc.rb
@@ -34,5 +34,11 @@ module Gitlab
 
       html.html_safe
     end
+
+    # Does the given document contain a valid :stem: attribute declaration
+    # that activates support for STEM (i.e. math)?
+    def self.contains_stem?(input)
+      input =~ /^:stem:/
+    end
   end
 end
diff --git a/lib/gitlab/gon_helper.rb b/lib/gitlab/gon_helper.rb
index 2c21804..d4abfaa 100644
--- a/lib/gitlab/gon_helper.rb
+++ b/lib/gitlab/gon_helper.rb
@@ -8,6 +8,7 @@ module Gitlab
       gon.shortcuts_path         = help_page_path('shortcuts')
       gon.user_color_scheme      = Gitlab::ColorSchemes.for_user(current_user).css_class
       gon.award_menu_url         = emojis_path
+      gon.mathjax_config         = Gitlab.config.extra.mathjax_config
 
       if current_user
         gon.current_user_id = current_user.id
-- 
1.9.5 (Apple Git-50.3)

