# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=gitaly
pkgver=1.12.2
pkgrel=0
pkgdesc="A Git RPC service for handling all the git calls made by GitLab"
url="https://gitlab.com/gitlab-org/gitaly/"
arch="all"
license="MIT"
pkgusers="git"
depends="git>=2.9.0 ruby ruby-bigdecimal ruby-bundler ruby-io-console ruby-json"
makedepends="
	go>=1.9
	icu-dev
	libgit2-dev=~0.27
	libxml2-dev
	libxslt-dev
	ruby-dev
	ruby-grpc=~1.15.0
	zlib-dev
	"
source="https://gitlab.com/gitlab-org/$pkgname/-/archive/v$pkgver/$pkgname-v$pkgver.tar.gz
	gemfile-use-local-grpc.patch
	config.patch
	$pkgname.initd"
builddir="$srcdir/$pkgname-v$pkgver"
options="!check"

prepare() {
	local sysgemdir=$(ruby -e 'puts Gem.default_dir')

	default_prepare

	# This Google gem is totally messed, so we copy our fixed version
	# instead of installing it from RubyGems using Bundler.
	mkdir -p ruby/vendor/grpc
	cp -r "$sysgemdir"/gems/grpc-*/* ruby/vendor/grpc/
	cp "$sysgemdir"/specifications/grpc-*.gemspec \
		ruby/vendor/grpc/grpc.gemspec
	cp "$sysgemdir"/extensions/*/*/grpc-*/grpc/grpc_c.so \
		ruby/vendor/grpc/src/ruby/lib/grpc/
}

build() {
	cd "$builddir"/ruby
	bundle config build.nokogiri --use-system-libraries \
		--with-xml2-include=/usr/include/libxml2 \
		--with-xslt-include=/usr/include/libxslt
	bundle config build.rugged --use-system-libraries

	cd "$builddir"
	make VERSION=$pkgver \
		BUNDLE_FLAGS="--deployment --jobs=${JOBS:-2} --no-cache --without development test"
}

package() {
	local rubydir="$pkgdir/usr/lib/bundles/$pkgname-ruby"

	## Go part

	cd "$builddir"

	make install VERSION=$pkgver DESTDIR="$pkgdir" PREFIX=/usr
	install -m644 -D config.toml.example "$pkgdir"/etc/gitlab/gitaly.toml
	install -m755 -D "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/gitlab.gitaly

	## Ruby part

	mkdir -p "${rubydir%/*}"
	cp -a ruby "$rubydir"

	# Remove tests.
	rm -R "$rubydir"/spec

	cd "$rubydir"/vendor/bundle/ruby/*/gems

	# Remove tests, docs and other unnecessary files.
	rm -Rf */spec \
		*/test \
		*/tests \
		*/*.md \
		*/*.rdoc \
		*/*.txt \
		*/CHANGELOG* \
		*/CONTRIBUT* \
		*/*LICENSE* \
		*/Rakefile \
		*/README*

	# Remove bundled libgit2 sources.
	rm -R rugged-*/vendor/libgit2

	# Remove assets, they are not used in gitaly-ruby.
	rm -R gemojione-*/assets

	# Remove sources and binaries of native extensions (they are installed
	# in extensions directory).
	find . -type d -name ext -maxdepth 2 -exec rm -frv '{}' +
	find . -name '*.so' -delete

	# Remove build logs and cache.
	rm -R ../build_info/ ../cache/
	find ../extensions/ \
		-name gem_make.out -delete \
		-o -name mkmf.log -delete
}

sha512sums="c2bd1b713694380808c3e3b42c7b8ea5e81477a90d022fc68a9b7de0c572bda4a6c72cdcb2e76dfdcb5b0e7cf56e88af6ee8b7784cb17e568d4808238e1e9cd1  gitaly-v1.12.2.tar.gz
83ebee5145382965ffcf82366db7cd3d0655f42e980e19272629aee52333150c3b0e7938440797a68a47cafb78213d714e60730939d5931bec36abf034ab6b81  gemfile-use-local-grpc.patch
e8f308a68586f2aed4357826d39415c049c4be9aea0df06e95cf9e91960bbec1ca28df34a2a6aa1052e792fd71c35863e17b28e41849c907ce66ace24b3c7560  config.patch
7e31fdeaa83e11ae345a53566c45b2baabfc1f87210b45c8423c5e352ed98e2bb6e1d03233fe8359fdeed05c8a0312ea38d8bed105d1becc72d3dd78221b70ca  gitaly.initd"
