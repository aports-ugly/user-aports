# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=mailman
# Note: When bumping pkgver, wipe constraints.txt, run abuild -r, then
# abuild checksum and commit the updated constraints.txt.
pkgver=3.1_git20161114
_mailman_ref=54d32b872ee4e67a64a176077dbc49a4f87b9324  # master/HEAD
_mmhyperkitty_ref=77cabcea62372a2b2d3533e1d4dba94a766b7428  # 1.0.2 (not tagged)
pkgrel=0
pkgdesc="The GNU Mailing List Management System"
url="http://www.list.org/"
arch="all"
license="GPLv3"
depends=""
_pyver=3.4
makedepends="python$_pyver-dev postgresql-dev"
install="$pkgname.pre-install $pkgname.post-install"
pkgusers="mailman"
pkggroups="mailman"
source="$pkgname-$_mailman_ref.tar.gz::https://gitlab.com/mailman/$pkgname/repository/archive.tar.gz?ref=$_mailman_ref
	$pkgname-hyperkitty-$_mmhyperkitty_ref.tar.gz::https://gitlab.com/mailman/$pkgname-hyperkitty/repository/archive.tar.gz?ref=$_mmhyperkitty_ref
	constraints.txt
	$pkgname.initd
	$pkgname.logrotate
	mailman.cfg
	hyperkitty.cfg"
builddir="$srcdir/build"

_mailman_dir="$srcdir/$pkgname-$_mailman_ref-$_mailman_ref"
_mmhyperkitty_dir="$srcdir/$pkgname-hyperkitty-$_mmhyperkitty_ref-$_mmhyperkitty_ref"
_prefix="/usr/lib/bundles/$pkgname"

prepare() {
	mkdir -p "$builddir"

	cd "$srcdir"
	ln -s "$_mailman_dir" mailman || return 1
	ln -s "$_mmhyperkitty_dir" mailman-hyperkitty || return 1

	local builddir="$srcdir"
	default_prepare
}

build() {
	local extra_eggs="psycopg2"

	cd "$builddir"

	# Create virtualenv.
	python$_pyver -m venv . || return 1

	bin/python -m pip install \
		--disable-pip-version-check \
		--install-option="--no-compile" \
		--isolated \
		--no-cache-dir \
		--constraint "$srcdir"/constraints.txt \
		"$_mailman_dir" "$_mmhyperkitty_dir" \
		$extra_eggs || return 1

	# Note: This overwrites existing constraints.txt.
	bin/python -m pip freeze --disable-pip-version-check \
		| sed -E '/^(mailman|mailman-hyperkitty)==.*/d' \
		> "$srcdir"/constraints.txt || return 1

	# Remove pip that is not needed in runtime (note: setuptools is needed).
	bin/python -m pip uninstall --disable-pip-version-check -y pip || return 1

	# Fix shebang to correct destination.
	find ./bin -type f -exec sed -i "s|$builddir|$_prefix|g" {} \; || return 1

	# Remove some unnecessary scripts and directories.
	rm -f bin/activate.* bin/easy_install* bin/falcon-bench bin/nose*
	rm -Rf man include lib64

	# Remove tests.
	find lib/$python/ -name "test_*.py" -delete
	rm -Rf lib/$python/site-packages/falcon/bench

	bin/python -m compileall -f -d "$_prefix/lib" lib
}

package() {
	mkdir -p "${pkgdir}${_prefix}"
	cd "$pkgdir" || return 1

	mv "$builddir"/* .$_prefix/ || return 1

	mkdir -p ./usr/bin
	ln -s $_prefix/bin/mailman ./usr/bin/mailman || return 1

	install -m 640 -g mailman -D "$srcdir"/mailman.cfg \
		./etc/mailman.cfg || return 1

	install -m 640 -g mailman -D "$srcdir"/hyperkitty.cfg \
		./etc/mailman.d/hyperkitty.cfg || return 1

	install -m 755 -D "$srcdir"/$pkgname.initd \
		./etc/init.d/$pkgname || return 1

	install -m 644 -D "$srcdir"/$pkgname.logrotate \
		./etc/logrotate.d/$pkgname || return 1

	install -d -m 750 -o mailman -g mailman \
		./var/lib/mailman \
		./var/log/mailman || return 1

	install -d -m 700 -o mailman -g mailman \
		./var/spool/mailman \
		./var/cache/mailman
}

md5sums="75b4f26064aeeaca87b00910ba4929c4  mailman-54d32b872ee4e67a64a176077dbc49a4f87b9324.tar.gz
5ed4e82fbb8742b445a334eaae375752  mailman-hyperkitty-77cabcea62372a2b2d3533e1d4dba94a766b7428.tar.gz
dcc24ad96e237d4621401214056b217a  constraints.txt
1f37b98042d6e926c3e7ccbbbc5bb111  mailman.initd
219b397b0d9795c190fccb66fdb6af97  mailman.logrotate
81bad5da04a96c7d4a9a203aa4603228  mailman.cfg
7d4800b9adf5865c813b10534166d24f  hyperkitty.cfg"
sha256sums="5946d1a2699505e8a01ef7d462b59ace78da31251ea3c9f592c0a3fc8fdcf008  mailman-54d32b872ee4e67a64a176077dbc49a4f87b9324.tar.gz
506c7d86cf3d16659740bb429030addbe5c9e3f55bf808600d4dc5ae8198ff9e  mailman-hyperkitty-77cabcea62372a2b2d3533e1d4dba94a766b7428.tar.gz
4df2be8a033f28b7d996492fec4680baf77e20e813dd92d783f580ea982285fd  constraints.txt
9ccec1e391c48d22d1ba05a35a9719bc9254bf082767070aac40d3a875b12d8b  mailman.initd
0914f82c113d19d7690b74556b1b8b244c95f033398da9be16aa5d874b0336c8  mailman.logrotate
0e2e5b775cb6068b68d9df84d926b09d690c5e4def5bbef3f3b59677bab84ea8  mailman.cfg
16166d2a1bd8cc189494a1444f9789a38db455eb8dd5f34e360f65f0477a2891  hyperkitty.cfg"
sha512sums="16640cc54bebc00b6881ba9be72f9cf119cfd6c383ead683bdfdd0d1c7451da4dc9177d2367ef5e68cf65c26f2b7aeeb4f523a4d4cacc51344b302ec148b09ae  mailman-54d32b872ee4e67a64a176077dbc49a4f87b9324.tar.gz
f79bedfb05aa732d1ef9048ece23187d66ef2ada752537d0f1240f7efed580953240edf73bfc15a41ae424414b0a64c28d0b4608e93760d33091944acd908b49  mailman-hyperkitty-77cabcea62372a2b2d3533e1d4dba94a766b7428.tar.gz
cead6ddfa2da394e2fb5e27e8d5b276f2cd6cdbbd534a085d069d4f93c1ded0e0d603b9810ad388e5b65726a96aa1e2a8ee89c6fc24753de1b10726201d2c134  constraints.txt
006a1cda6bc25742b99d8803a4d5d4ab8cf7f1a066d75559874f2fd5dfa8d0a1b2033c9a288a1b71a090649de372205e0a2c8dea2165f5efd57f5bdeaea2f199  mailman.initd
31e6fd356d9b0e04ab28596828539260995e33688b27baae525b16fb103449c59ea291146f749f51dd1e34bb2b718c785c4828d739896a3ca6fadedc14d67f47  mailman.logrotate
3c80e1eab46fc10d1322881a57591cc3c691f89d501a8e80a4258965c727b102cce4e0e840e55be181c83510ea2c1311cc1421ecdbcf9e3e27c6897af3215a34  mailman.cfg
6c5211a48671616b3d700807d7267ddbf7759c219d2ac6b4ccf05a745f0cae29b27f38c4a48f5b9736f451a4665acc4caf56c7bb8b52a497d85100bfdd8f7397  hyperkitty.cfg"
